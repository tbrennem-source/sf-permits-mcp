name: Nightly Data Sync & Morning Briefs

on:
  schedule:
    # Nightly delta fetch: 3 AM Pacific = 11:00 UTC
    - cron: '0 11 * * *'
  workflow_dispatch:  # Allow manual trigger from GitHub Actions UI

jobs:
  nightly-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    steps:
      - name: Trigger nightly data sync
        run: |
          echo "Triggering nightly delta fetch at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/nightly_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/nightly")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/nightly_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/nightly_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::error::Nightly sync failed with HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Wait for nightly sync processing
        run: sleep 30

      - name: Refresh RAG embeddings
        run: |
          echo "Triggering RAG ingest at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/rag_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/rag-ingest?tier=all&clear=0")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/rag_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/rag_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::RAG ingest failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for RAG processing
        run: sleep 15

      - name: Trigger morning briefs
        run: |
          echo "Triggering morning briefs at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/briefs_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/send-briefs")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/briefs_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/briefs_response.json
          # Briefs failure is non-critical â€” don't fail the job
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Brief send failed with HTTP $HTTP_STATUS (non-critical)"
          fi
