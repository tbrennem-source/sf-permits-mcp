name: Nightly Data Sync & Morning Briefs

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allow manual trigger from GitHub Actions UI

jobs:
  nightly-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run after scheduled CI (not push/PR CI), and only if CI passed.
    # workflow_dispatch bypasses this condition for manual triggers.
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'schedule')
    steps:
      - name: Trigger nightly data sync
        run: |
          echo "Triggering nightly delta fetch at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/nightly_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/nightly")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/nightly_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/nightly_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::error::Nightly sync failed with HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Extract MCP access report
        run: |
          if [ -f /tmp/nightly_response.json ]; then
            python3 -c "
          import json
          try:
              data = json.load(open('/tmp/nightly_response.json'))
              r = data.get('mcp_access_report', {})
              total = r.get('total_requests_24h', 'N/A')
              ips = r.get('unique_ips_24h', 'N/A')
              limited = r.get('rate_limited_24h', 0)
              top = r.get('top_ips', [])
              lines = []
              lines.append(f'MCP Access Report (24h)')
              lines.append(f'  Requests: {total}  |  Unique IPs: {ips}  |  Rate limited: {limited}')
              for t in top[:5]:
                  lines.append(f'  {t[\"ip\"]}: {t[\"requests\"]} reqs — {t.get(\"user_agent\",\"\")[:50]}')
              print('\n'.join(lines))
              with open('/tmp/mcp_access_report.txt', 'w') as f:
                  f.write('\n'.join(lines))
          except Exception as e:
              print(f'MCP access report extraction failed: {e}')
          " 2>/dev/null || echo "MCP access report: not available"
          fi

      - name: Wait for nightly sync processing
        run: sleep 30

      - name: Refresh electrical permits
        run: |
          echo "Ingesting electrical permits at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-electrical" || echo "WARNING: electrical ingest failed"

      - name: Refresh plumbing permits
        run: |
          echo "Ingesting plumbing permits at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-plumbing" || echo "WARNING: plumbing ingest failed"

      - name: Refresh street-use permits
        run: |
          echo "Ingesting street-use permits at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-street-use" || echo "WARNING: street-use ingest failed"

      - name: Refresh development pipeline
        run: |
          echo "Ingesting development pipeline at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-development-pipeline" || echo "WARNING: development pipeline ingest failed"

      - name: Refresh affordable housing pipeline
        run: |
          echo "Ingesting affordable housing at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-affordable-housing" || echo "WARNING: affordable housing ingest failed"

      - name: Refresh housing production
        run: |
          echo "Ingesting housing production at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-housing-production" || echo "WARNING: housing production ingest failed"

      - name: Refresh dwelling completions
        run: |
          echo "Ingesting dwelling completions at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-dwelling-completions" || echo "WARNING: dwelling completions ingest failed"

      - name: Refresh plumbing inspections
        run: |
          echo "Ingesting plumbing inspections at $(date -u)..."
          curl -sf -X POST -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/ingest-plumbing-inspections" || echo "WARNING: plumbing inspections ingest failed"

      - name: Run signal detection pipeline
        run: |
          echo "Triggering signal pipeline at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/signals_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/signals")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/signals_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/signals_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Signal pipeline failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for signal processing
        run: sleep 15

      - name: Refresh station velocity baselines
        run: |
          echo "Triggering velocity refresh at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/velocity_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/velocity-refresh")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/velocity_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/velocity_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Velocity refresh failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for velocity processing
        run: sleep 10

      - name: Refresh RAG embeddings (ops chunks only — tier1-4 are static)
        run: |
          echo "Triggering RAG ops ingest at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/rag_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/rag-ingest?tier=ops")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/rag_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/rag_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::RAG ingest failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for RAG processing
        run: sleep 15

      - name: Trigger morning briefs
        run: |
          echo "Triggering morning briefs at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/briefs_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/send-briefs")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/briefs_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/briefs_response.json
          # Briefs failure is non-critical — don't fail the job
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Brief send failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Send Telegram alert on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
            MSG="⚠️ *Nightly Cron Failed*%0A%0AOne or more nightly pipeline steps failed.%0A%0A[View run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode=Markdown \
              -d text="$MSG" || echo "Telegram notification failed"
          fi
