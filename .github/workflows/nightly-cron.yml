name: Nightly Data Sync & Morning Briefs

on:
  workflow_run:
    workflows: ["CI"]
    types: [completed]
    branches: [main]
  workflow_dispatch:  # Allow manual trigger from GitHub Actions UI

jobs:
  nightly-sync:
    runs-on: ubuntu-latest
    timeout-minutes: 20
    # Only run after scheduled CI (not push/PR CI), and only if CI passed.
    # workflow_dispatch bypasses this condition for manual triggers.
    if: >-
      github.event_name == 'workflow_dispatch' ||
      (github.event.workflow_run.conclusion == 'success' &&
       github.event.workflow_run.event == 'schedule')
    steps:
      - name: Trigger nightly data sync
        run: |
          echo "Triggering nightly delta fetch at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/nightly_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/nightly")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/nightly_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/nightly_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::error::Nightly sync failed with HTTP $HTTP_STATUS"
            exit 1
          fi

      - name: Wait for nightly sync processing
        run: sleep 30

      - name: Run signal detection pipeline
        run: |
          echo "Triggering signal pipeline at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/signals_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/signals")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/signals_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/signals_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Signal pipeline failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for signal processing
        run: sleep 15

      - name: Refresh station velocity baselines
        run: |
          echo "Triggering velocity refresh at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/velocity_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/velocity-refresh")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/velocity_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/velocity_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Velocity refresh failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for velocity processing
        run: sleep 10

      - name: Refresh RAG embeddings (ops chunks only — tier1-4 are static)
        run: |
          echo "Triggering RAG ops ingest at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/rag_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/rag-ingest?tier=ops")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/rag_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/rag_response.json
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::RAG ingest failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Wait for RAG processing
        run: sleep 15

      - name: Trigger morning briefs
        run: |
          echo "Triggering morning briefs at $(date -u)..."
          HTTP_STATUS=$(curl -s -o /tmp/briefs_response.json -w "%{http_code}" \
            -X POST \
            -H "Authorization: Bearer ${{ secrets.CRON_SECRET }}" \
            "${{ secrets.BASE_URL }}/cron/send-briefs")
          echo "HTTP Status: $HTTP_STATUS"
          cat /tmp/briefs_response.json | python3 -m json.tool 2>/dev/null || cat /tmp/briefs_response.json
          # Briefs failure is non-critical — don't fail the job
          if [ "$HTTP_STATUS" -ge 500 ]; then
            echo "::warning::Brief send failed with HTTP $HTTP_STATUS (non-critical)"
          fi

      - name: Send Telegram alert on failure
        if: failure()
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
        run: |
          if [ -n "$TELEGRAM_BOT_TOKEN" ]; then
            MSG="⚠️ *Nightly Cron Failed*%0A%0AOne or more nightly pipeline steps failed.%0A%0A[View run](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})"
            curl -s -X POST \
              "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
              -d chat_id="${TELEGRAM_CHAT_ID}" \
              -d parse_mode=Markdown \
              -d text="$MSG" || echo "Telegram notification failed"
          fi
