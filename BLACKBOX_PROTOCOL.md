# BLACKBOX_PROTOCOL.md — Autonomous Build Session Protocol

**Owner:** dforge
**Version:** 1.1
**Last Updated:** 2026-02-25

---

## What This File Is

This is the executable protocol for autonomous Claude Code build sessions. It is not advisory. It is not a template to customize. CC reads this file and follows it literally.

Every repo that uses the Black Box pattern includes this line in its CLAUDE.md:

```
## Black Box Protocol: active
See BLACKBOX_PROTOCOL.md for the mandatory session structure.
```

CC must read this file at session start. If this file is not present, CC must stop and ask where it is before building anything.

---

## Session Structure

Every Black Box session has exactly two stages. Both are mandatory. Neither can be skipped.

### Stage 1: termCC (Terminal Claude Code)

Runs in terminal. Builds code, runs tests, generates QA artifacts.

**Phase order is fixed. Do not reorder. Do not skip phases.**

```
READ → BUILD → TEST → SCENARIOS → QA → CHECKCHAT
```

#### READ

1. Read this file (BLACKBOX_PROTOCOL.md)
2. Read the repo's CLAUDE.md
3. Read the repo's DEPLOYMENT_MANIFEST.yaml (location declared in CLAUDE.md)
4. Read the mission prompt (the task you were given)
5. Read any spec files referenced in the mission prompt

**Gate:** Do not proceed to BUILD until you can state:
- What topology this repo uses (from manifest)
- What URLs you will verify against (from manifest)
- How many DeskRelay prompts you must generate (from manifest)

#### BUILD

Build what the mission prompt says. Follow the repo's PRINCIPALS.md and CLAUDE.md rules.

**Rules during BUILD:**
- No curl/fetch against prod URLs. Staging only.
- No database mutations against prod. Staging only.
- If the manifest says `topology: two-branch`, all remote operations target staging until DeskRelay-staging passes and promotion occurs.

#### TEST

Run the repo's test suite. All tests must pass.

```bash
# Standard pattern — repo may override in CLAUDE.md
pytest tests/ -v
```

**Gate:** Do not proceed to SCENARIOS if tests fail. Fix failures first. After 3 failed fix attempts, mark as BLOCKED and proceed to CHECKCHAT with BLOCKED status.

#### SCENARIOS

Append suggested scenarios to `scenarios-pending-review.md` in the repo root. Create the file if it doesn't exist.

**Rules:**
- CC does NOT modify `scenario-design-guide.md` or any authoritative scenario file
- Scenarios go to the staging file only
- Use the format defined in the repo's CLAUDE.md
- Aim for 2-5 scenarios per session
- Tag each with CC confidence: high / medium / low

#### QA (termRelay)

Spawn QA subagents using headless Playwright. Each subagent:
- Navigates to the **staging URL** (from manifest, never prod)
- Takes screenshots to `qa-results/screenshots/{sprint-id}/`
- Writes PASS/FAIL results to `qa-results/{sprint-id}-staging-results.md`

**Subagent categories** (spawn what's relevant, skip what isn't):
- **Public:** Landing page, search, unauthenticated features
- **Auth:** Login flow, authenticated features
- **Admin:** Admin-only features, cron endpoints
- **API:** Health checks, data endpoints

**Gate:** All relevant subagent categories must PASS before proceeding to CHECKCHAT. After 3 failed fix attempts per category, mark as BLOCKED.

#### CHECKCHAT

Session close protocol. Six steps, all mandatory.

**Step 1 — VERIFY:** Confirm QA gate status. List any BLOCKED items.

**Step 2 — DOCUMENT:** Update STATUS.md and CHANGELOG.md in the repo.

**Step 3 — CAPTURE:** Confirm scenarios were appended to `scenarios-pending-review.md`.

**Step 4 — SHIP:** Push to the repo's development branch (usually `main`). Update Chief if the repo uses Chief Hub Protocol.

**Step 5 — GENERATE DESKRELAY PROMPT:** This is mandatory. Read the DEPLOYMENT_MANIFEST.yaml and generate the DeskRelay prompt file.

> **This step is not optional. This step cannot be skipped. If you close a session without generating a DeskRelay prompt, the session is incomplete.**

See [DeskRelay Prompt Generation](#deskrelay-prompt-generation) below for the exact rules.

**Step 6 — BLOCKED ITEMS REPORT:** List anything that couldn't be completed, with root cause and suggested next step.

Output the CHECKCHAT summary to the terminal. Include the line:

```
DESKRELAY PROMPT: qa-drop/{sprint-id}-deskrelay-prompt.md
```

---

### Stage 2: DeskCC (Desktop Claude Code)

Runs in Desktop Claude Code. Visual verification only. No code changes except the promotion ceremony.

DeskCC receives the DeskRelay prompt file generated by Stage 1. It executes the parts sequentially (staging checks → promotion → prod checks). When done, it runs a lightweight CHECKCHAT: commit QA artifacts, push, note any follow-ups.

**DeskCC rules:**
- No code changes (except git promotion commands if specified in the prompt)
- Only produces QA artifacts (screenshots, results files)
- If a visual check fails, document the failure — do NOT attempt to fix code

---

## DeskRelay Prompt Generation

This is the most important section of this protocol. Getting this wrong means prod goes unverified.

### Read the Manifest

The repo's `DEPLOYMENT_MANIFEST.yaml` declares the topology. The topology determines the DeskRelay prompt structure.

All topologies generate **one file:** `qa-drop/{sprint-id}-deskrelay-prompt.md`. Sequential steps go in one file — never split across multiple files.

### Topology: `no-deploy`

Library or tool with no deployment. No DeskRelay prompt needed. Skip Step 5.

### Topology: `single-branch`

One environment, one branch, one URL.

**Generate 1 file:** `qa-drop/{sprint-id}-deskrelay-prompt.md`

Contents:
1. `cd {repo_path}` (from manifest)
2. Visual checks against the single environment URL
3. Screenshots to `qa-results/screenshots/{sprint-id}-deskrelay/`
4. Results to `qa-results/{sprint-id}-deskrelay-results.md`
5. Lightweight CHECKCHAT (commit, push)

### Topology: `two-branch`

Two environments (staging + prod), two branches, promotion ceremony between them.

**Generate 1 file:** `qa-drop/{sprint-id}-deskrelay-prompt.md`

The file has sequential parts — staging verification, then promotion, then prod verification. DeskCC executes them in order within a single session.

**Part 1 — Staging Checks:**
1. `cd {repo_path}`
2. Visual checks against `staging_url` (from manifest)
3. Screenshots to `qa-results/screenshots/{sprint-id}-deskrelay-staging/`

**Part 2 — Promotion Ceremony** (only if staging checks PASS):
4. Run the promotion command:
   ```
   {promotion_command}
   ```
   (Exact command from manifest. Do not improvise.)
5. Wait for prod deploy (manifest specifies `deploy_wait_seconds`)
6. Run any `post_promotion_commands` from manifest (migrations, data loads, etc.)

**Part 3 — Prod Checks:**
7. Visual checks against `prod_url` (from manifest)
8. Same check categories as staging
9. Screenshots to `qa-results/screenshots/{sprint-id}-deskrelay-prod/`

**Part 4 — Close:**
10. Write results to `qa-results/{sprint-id}-deskrelay-results.md` (both staging + prod results)
11. Lightweight CHECKCHAT (commit, push, update Chief if applicable)

### What Every DeskRelay Prompt Must Contain

Regardless of topology, every generated DeskRelay prompt must include:

1. **Repo path** — `cd` command at the top
2. **Context** — brief summary of what was built this sprint
3. **Target URL(s)** — which environment(s) to verify
4. **Health check** — hit the health endpoint, verify response
5. **Visual checks** — numbered steps with explicit PASS/FAIL criteria
6. **Screenshot paths** — where to save evidence
7. **Results file path** — where to write the report
8. **No-code-changes rule** — explicit statement that DeskCC must not modify code
9. **Lightweight CHECKCHAT** — commit QA artifacts, push

For `two-branch`, the file must have clearly labeled sequential parts (staging → promotion → prod) so DeskCC executes them in order.

### DeskRelay Prompt Template (single-branch)

```markdown
# {sprint-id} — DeskRelay Verification

## Context
{Brief summary of what was built}

## Setup
cd {repo_path}

## Rules
- NO code changes. QA artifacts only.
- If a check fails, document it. Do NOT attempt fixes.

## Visual Checks
Target: {url}

1. [ ] Health endpoint — curl -s {url}/health | python3 -m json.tool
2. [ ] Landing page loads — title contains expected text
3. [ ] {additional checks from termRelay HANDOFF section}

Screenshots to: qa-results/screenshots/{sprint-id}-deskrelay/
Results to: qa-results/{sprint-id}-deskrelay-results.md

## Close
Lightweight CHECKCHAT: commit, push, note follow-ups.
```

### DeskRelay Prompt Template (two-branch)

```markdown
# {sprint-id} — DeskRelay: Staging → Promotion → Prod

## Context
{Brief summary of what was built}

## Setup
cd {repo_path}

## Rules
- NO code changes. QA artifacts only.
- If a check fails, document it. Do NOT attempt fixes.

---

## Part 1: Staging Checks
Target: {staging_url}

1. [ ] Health endpoint returns 200 with expected data
2. [ ] Landing page loads without errors
3. [ ] {feature-specific checks}

Screenshots to: qa-results/screenshots/{sprint-id}-deskrelay-staging/

---

## Part 2: Promotion Ceremony
(Only if all staging checks PASS)

{promotion_command}

Wait {deploy_wait_seconds}s for prod deploy.
{post_promotion_commands if any}

---

## Part 3: Prod Checks
Target: {prod_url}

4. [ ] Health endpoint returns 200 with expected data
5. [ ] Landing page loads without errors
6. [ ] {same feature-specific checks as staging}

Screenshots to: qa-results/screenshots/{sprint-id}-deskrelay-prod/

---

## Part 4: Close
Results to: qa-results/{sprint-id}-deskrelay-results.md
Lightweight CHECKCHAT: commit, push, update Chief.
```

---

## Enforcement Rules

These rules exist because CC has historically violated them. They are the teeth.

### E-1: No Prod Before Staging
CC must not curl, fetch, query, or interact with `prod_url` during Stage 1 (termCC). The only exception is read-only health checks for comparison purposes, and only after staging health check passes.

### E-2: No Skipping DeskRelay Generation
CHECKCHAT is not complete without a DeskRelay prompt file. If the CHECKCHAT summary does not include the `DESKRELAY PROMPT:` line, the session is incomplete. Go back and generate it.

### E-3: No Custom Deployment Steps
CC must not invent deployment commands. All deployment commands come from `DEPLOYMENT_MANIFEST.yaml`. If a needed command isn't in the manifest, flag it as a BLOCKED item — do not improvise.

### E-4: No Prose URLs
CC must not write URLs from memory. All URLs come from the manifest. Copy-paste, not recall.

### E-5: Test Before Ship
`git push` must not happen before `pytest` passes. This is not negotiable.

### E-6: Three Strikes
Any failing step gets 3 fix attempts. After 3 failures, mark BLOCKED and move on. Do not loop indefinitely.

### E-7: Manifest Is Canon
If the mission prompt contradicts the manifest (e.g., "deploy to prod first"), the manifest wins. Flag the contradiction in CHECKCHAT but follow the manifest.

---

## Manifest Schema Reference

See DEPLOYMENT_MANIFEST_SPEC.md for the full schema. Quick reference:

```yaml
# Required fields
topology: two-branch | single-branch | no-deploy
repo_path: /Users/timbrenneman/AIprojects/sf-permits-mcp

# Required for single-branch and two-branch
health_endpoint: /health
test_command: pytest tests/ -v
staging_url: https://example-staging.up.railway.app

# Required for two-branch only
prod_url: https://example-production.up.railway.app
staging_branch: main
prod_branch: prod
promotion_command: "git checkout prod && git merge main && git push origin prod"
deploy_wait_seconds: 120
post_promotion_commands: []

# Optional
test_query: "robin hood"
auth_secret_env: CRON_SECRET
chief_project_slug: sf-permits-mcp
```

---

## How Repos Adopt This Protocol

1. Add `DEPLOYMENT_MANIFEST.yaml` to repo root
2. Add to CLAUDE.md:
   ```
   ## Black Box Protocol: active
   ## Deployment Manifest: DEPLOYMENT_MANIFEST.yaml
   ```
3. Ensure `qa-drop/` and `qa-results/` directories exist (or are created on first run)
4. Done. CC reads the protocol, reads the manifest, follows the rules.

---

## Version History

| Date | Change | Reason |
|------|--------|--------|
| 2026-02-25 | v1.1 — Single DeskRelay file for all topologies | Sequential steps (staging → promote → prod) belong in one file. Two-branch no longer generates 2 separate files. |
| 2026-02-25 | v1.0 — Initial protocol | Sprint 54 post-mortem: CC skipped staging verification, generated single DeskRelay for two-branch topology, wrote prod URLs from memory instead of manifest |
