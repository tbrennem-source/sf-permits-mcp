<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="robots" content="noindex, nofollow">
<title>sfpermits.ai — Admin Home</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@300;400;500&family=IBM+Plex+Sans:wght@300;400;500;600&display=swap" rel="stylesheet">
<script src="https://cdn.tailwindcss.com"></script>
<script defer src="https://cdn.jsdelivr.net/npm/alpinejs@3.x.x/dist/cdn.min.js"></script>
<script>
tailwind.config = {
  theme: {
    extend: {
      colors: {
        obsidian:    { DEFAULT: '#0a0a0f', mid: '#12121a', light: '#1a1a26' },
        glass:       { DEFAULT: 'rgba(255,255,255,0.04)', border: 'rgba(255,255,255,0.06)', hover: 'rgba(255,255,255,0.08)' },
        accent:      { DEFAULT: '#5eead4', glow: 'rgba(94,234,212,0.08)', ring: 'rgba(94,234,212,0.2)' },
        signal:      { green: '#4ade80', amber: '#fbbf24', red: '#f87171' },
      },
      fontFamily: {
        mono: ['JetBrains Mono', 'monospace'],
        sans: ['IBM Plex Sans', '-apple-system', 'sans-serif'],
      },
    }
  }
}
</script>
<style>
  html { scroll-behavior: smooth; scrollbar-width: thin; scrollbar-color: rgba(255,255,255,0.06) transparent; }
  body { -webkit-font-smoothing: antialiased; }
  @keyframes pulse-dot { 0%, 100% { opacity: 0.4; } 50% { opacity: 1; } }
  .pulse-dot { animation: pulse-dot 2s ease-in-out infinite; }
</style>
</head>

<body class="bg-obsidian text-white/90 font-sans min-h-screen">

<!-- TOP BAR -->
<header class="border-b border-glass-border px-6 py-3 flex items-center justify-between">
  <div class="flex items-center gap-4">
    <a href="/" class="font-mono text-xs tracking-[0.2em] uppercase text-white/25 hover:text-white/50 transition-colors">sfpermits.ai</a>
    <span class="font-mono text-xs text-accent">admin</span>
  </div>
  <div class="flex items-center gap-4">
    <span class="font-mono text-[10px] text-white/25">{{ user.email if user else '' }}</span>
    <a href="/auth/logout" class="font-mono text-[10px] text-white/25 hover:text-accent transition-colors">logout</a>
  </div>
</header>

<!-- MAIN CONTENT -->
<main class="max-w-[1200px] mx-auto px-6 py-8" x-data="adminDashboard()">

  <!-- SYSTEM HEALTH ROW -->
  <div class="mb-8">
    <div class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25 mb-3">system health</div>
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <!-- Cron -->
      <div class="bg-glass border border-glass-border rounded-lg p-4 hover:bg-glass-hover transition-colors">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-1.5 h-1.5 rounded-full" :class="cron.status === 'ok' ? 'bg-signal-green pulse-dot' : 'bg-signal-red pulse-dot'"></span>
          <span class="font-mono text-[10px] text-white/45 uppercase tracking-wide">Nightly Cron</span>
        </div>
        <div class="font-mono text-lg font-light" :class="cron.status === 'ok' ? 'text-signal-green' : 'text-signal-red'" x-text="cron.age"></div>
        <div class="font-mono text-[9px] text-white/25 mt-1" x-text="cron.lastRun"></div>
      </div>

      <!-- DB -->
      <div class="bg-glass border border-glass-border rounded-lg p-4 hover:bg-glass-hover transition-colors">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-1.5 h-1.5 rounded-full bg-signal-green pulse-dot"></span>
          <span class="font-mono text-[10px] text-white/45 uppercase tracking-wide">Database</span>
        </div>
        <div class="font-mono text-lg font-light text-white/90" x-text="db.tables + ' tables'"></div>
        <div class="font-mono text-[9px] text-white/25 mt-1" x-text="db.rows"></div>
      </div>

      <!-- API Cost -->
      <div class="bg-glass border border-glass-border rounded-lg p-4 hover:bg-glass-hover transition-colors">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-1.5 h-1.5 rounded-full" :class="costs.pct < 80 ? 'bg-signal-green' : costs.pct < 95 ? 'bg-signal-amber' : 'bg-signal-red'"></span>
          <span class="font-mono text-[10px] text-white/45 uppercase tracking-wide">API Budget</span>
        </div>
        <div class="font-mono text-lg font-light text-white/90" x-text="'$' + costs.today"></div>
        <div class="font-mono text-[9px] text-white/25 mt-1" x-text="costs.pct + '% of daily limit'"></div>
      </div>

      <!-- Data Freshness -->
      <div class="bg-glass border border-glass-border rounded-lg p-4 hover:bg-glass-hover transition-colors">
        <div class="flex items-center gap-2 mb-2">
          <span class="w-1.5 h-1.5 rounded-full" :class="data.gaps === 0 ? 'bg-signal-green' : 'bg-signal-amber pulse-dot'"></span>
          <span class="font-mono text-[10px] text-white/45 uppercase tracking-wide">Data Gaps</span>
        </div>
        <div class="font-mono text-lg font-light" :class="data.gaps === 0 ? 'text-signal-green' : 'text-signal-amber'" x-text="data.gaps === 0 ? 'None' : data.gaps + ' days'"></div>
        <div class="font-mono text-[9px] text-white/25 mt-1">Last 7 days checked</div>
      </div>
    </div>
  </div>

  <!-- TWO-COLUMN LAYOUT -->
  <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">

    <!-- LEFT COLUMN (2/3) -->
    <div class="lg:col-span-2 space-y-6">

      <!-- DATA INGEST SUMMARY -->
      <div class="bg-glass border border-glass-border rounded-lg overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-glass-border">
          <span class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25">last nightly ingest</span>
          <a href="/admin/ops" class="font-mono text-[10px] text-accent hover:underline cursor-pointer">view pipeline</a>
        </div>
        <div class="grid grid-cols-3 md:grid-cols-6 divide-x divide-glass-border">
          <template x-for="item in ingestStats" :key="item.label">
            <div class="p-3 text-center">
              <div class="font-mono text-sm font-light text-white/90" x-text="item.count"></div>
              <div class="font-mono text-[9px] text-white/25 mt-0.5" x-text="item.label"></div>
            </div>
          </template>
        </div>
        <div class="px-4 py-2 border-t border-glass-border flex items-center justify-between">
          <span class="font-mono text-[9px] text-white/20" x-text="'Pipeline: ' + pipeline.elapsed + 's · ' + pipeline.steps + ' steps'"></span>
          <span class="font-mono text-[9px]" :class="pipeline.errors > 0 ? 'text-signal-amber' : 'text-white/20'" x-text="pipeline.errors + ' non-fatal errors'"></span>
        </div>
      </div>

      <!-- RECENT ACTIVITY TABLE -->
      <div class="bg-glass border border-glass-border rounded-lg overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-glass-border">
          <span class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25">recent activity</span>
          <a href="/admin/activity" class="font-mono text-[10px] text-white/25 hover:text-accent transition-colors">view all</a>
        </div>
        {% if activity %}
        <table class="w-full">
          <thead>
            <tr class="border-b border-glass-border">
              <th class="text-left px-4 py-2 font-mono text-[9px] font-normal text-white/25 uppercase tracking-wide">User</th>
              <th class="text-left px-4 py-2 font-mono text-[9px] font-normal text-white/25 uppercase tracking-wide">Action</th>
              <th class="text-right px-4 py-2 font-mono text-[9px] font-normal text-white/25 uppercase tracking-wide">When</th>
            </tr>
          </thead>
          <tbody>
            {% for a in activity %}
            <tr class="border-b border-white/[0.03] hover:bg-glass-hover transition-colors">
              <td class="px-4 py-2 font-mono text-[11px] text-white/70">{{ a.display_name or a.email or 'system' }}</td>
              <td class="px-4 py-2 font-sans text-[11px] text-white/45">{{ a.action }}</td>
              <td class="px-4 py-2 font-mono text-[10px] text-white/25 text-right">{{ a.age }}</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
        {% else %}
        <div class="px-4 py-8 text-center font-mono text-[11px] text-white/25">No recent activity</div>
        {% endif %}
      </div>

      <!-- FEEDBACK QUEUE -->
      <div class="bg-glass border border-glass-border rounded-lg overflow-hidden">
        <div class="flex items-center justify-between px-4 py-3 border-b border-glass-border">
          <div class="flex items-center gap-2">
            <span class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25">feedback queue</span>
            {% if feedback_count > 0 %}
            <span class="font-mono text-[9px] bg-signal-amber/10 text-signal-amber px-1.5 py-px rounded">{{ feedback_count }} pending</span>
            {% endif %}
          </div>
          <a href="/admin/feedback" class="font-mono text-[10px] text-white/25 hover:text-accent transition-colors">manage</a>
        </div>
        {% if feedback_items %}
        {% for f in feedback_items[:5] %}
        <div class="flex items-center justify-between px-4 py-2.5 border-b border-white/[0.03] hover:bg-glass-hover transition-colors group">
          <div class="flex items-center gap-3 min-w-0">
            <span class="w-1.5 h-1.5 rounded-full shrink-0 {% if f.feedback_type == 'bug' %}bg-signal-red{% elif f.feedback_type == 'feature' %}bg-accent{% else %}bg-signal-amber{% endif %}"></span>
            <span class="font-sans text-[11px] text-white/70 truncate">{{ f.message[:80] }}{% if f.message|length > 80 %}…{% endif %}</span>
          </div>
          <div class="flex items-center gap-3 shrink-0">
            <span class="font-mono text-[9px] text-white/25">{{ (f.page_url or '')[:20] }}</span>
          </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="px-4 py-8 text-center font-mono text-[11px] text-white/25">No pending feedback</div>
        {% endif %}
      </div>
    </div>

    <!-- RIGHT COLUMN (1/3) -->
    <div class="space-y-6">

      <!-- USERS -->
      <div class="bg-glass border border-glass-border rounded-lg p-4">
        <div class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25 mb-3">users</div>
        <div class="space-y-3">
          <div class="flex justify-between items-baseline">
            <span class="font-sans text-[11px] text-white/45">Total accounts</span>
            <span class="font-mono text-sm text-white/90">{{ user_count }}</span>
          </div>
          <div class="flex justify-between items-baseline">
            <span class="font-sans text-[11px] text-white/45">Active (7d)</span>
            <span class="font-mono text-sm text-white/90">{{ active_7d }}</span>
          </div>
          <div class="flex justify-between items-baseline">
            <span class="font-sans text-[11px] text-white/45">Beta requests</span>
            <span class="font-mono text-sm {% if beta_pending > 0 %}text-accent{% else %}text-white/90{% endif %}">{{ beta_pending }}</span>
          </div>
          <div class="flex justify-between items-baseline">
            <span class="font-sans text-[11px] text-white/45">Watchers</span>
            <span class="font-mono text-sm text-white/90">{{ watch_count }}</span>
          </div>
        </div>
        <div class="mt-4 pt-3 border-t border-glass-border">
          <a href="/admin/beta-requests" class="font-mono text-[10px] text-accent hover:underline">Review beta requests</a>
        </div>
      </div>

      <!-- QUICK LINKS -->
      <div class="bg-glass border border-glass-border rounded-lg p-4">
        <div class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25 mb-3">admin tools</div>
        <div class="space-y-1">
          <a href="/admin/feedback" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Feedback
          </a>
          <a href="/admin/activity" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Activity Log
          </a>
          <a href="/admin/ops" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Operations
          </a>
          <a href="/admin/costs" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> API Costs
          </a>
          <a href="/admin/pipeline" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Pipeline Health
          </a>
          <a href="/admin/metrics" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Metrics
          </a>
          <a href="/admin/qa" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> QA Runs
          </a>
          <a href="/admin/sources" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Data Sources
          </a>
          <a href="/admin/regulatory-watch" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Regulatory Watch
          </a>
          <a href="/admin/perf" class="flex items-center gap-2 px-2 py-1.5 rounded hover:bg-glass-hover transition-colors font-mono text-[11px] text-white/45 hover:text-accent">
            <span class="w-1 h-1 rounded-full bg-white/15"></span> Performance
          </a>
        </div>
      </div>

      <!-- DEPLOY STATUS -->
      <div class="bg-glass border border-glass-border rounded-lg p-4">
        <div class="font-mono text-[10px] tracking-[0.12em] uppercase text-white/25 mb-3">deploy</div>
        <div class="space-y-2">
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-signal-green pulse-dot"></span>
              <span class="font-mono text-[10px] text-white/45">prod</span>
            </div>
            <span class="font-mono text-[9px] text-white/25" x-text="deploy.prod"></span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-signal-green pulse-dot"></span>
              <span class="font-mono text-[10px] text-white/45">staging</span>
            </div>
            <span class="font-mono text-[9px] text-white/25" x-text="deploy.staging"></span>
          </div>
          <div class="flex items-center justify-between">
            <div class="flex items-center gap-2">
              <span class="w-1.5 h-1.5 rounded-full bg-signal-green pulse-dot"></span>
              <span class="font-mono text-[10px] text-white/45">mcp-api</span>
            </div>
            <span class="font-mono text-[9px] text-white/25" x-text="deploy.mcp"></span>
          </div>
        </div>
      </div>
    </div>
  </div>
</main>

<script>
function adminDashboard() {
  return {
    // System Health — static shell values (real data loaded from Flask context)
    cron: { status: 'ok', age: '—', lastRun: 'Checking...' },
    db: { tables: {{ db_table_count | default(59) }}, rows: '{{ db_row_summary | default("5.6M rows") }}' },
    costs: { today: '{{ api_cost_today | default("—") }}', pct: {{ api_cost_pct | default(0) }} },
    data: { gaps: {{ data_gap_days | default(0) }} },

    // Ingest stats — static display, updated nightly
    ingestStats: [
      { label: 'permits', count: '{{ ingest_permits | default("—") }}' },
      { label: 'inspections', count: '{{ ingest_inspections | default("—") }}' },
      { label: 'addenda', count: '{{ ingest_addenda | default("—") }}' },
      { label: 'planning', count: '{{ ingest_planning | default("—") }}' },
      { label: 'signals', count: '{{ ingest_signals | default("—") }}' },
      { label: 'velocity', count: '{{ ingest_velocity | default("—") }}' },
    ],
    pipeline: {
      elapsed: '{{ pipeline_elapsed | default("—") }}',
      steps: {{ pipeline_steps | default(0) }},
      errors: {{ pipeline_errors | default(0) }},
    },

    // Deploy — placeholder (no Railway API integration yet)
    deploy: {
      prod: 'sfpermits-ai-production.up.railway.app',
      staging: 'sfpermits-ai-staging.up.railway.app',
      mcp: 'sfpermits-mcp-api-production.up.railway.app',
    },
  }
}
</script>
</body>
</html>
