<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Morning Brief — sfpermits.ai</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #252834;
            --border: #333749;
            --text: #e4e6eb;
            --text-muted: #8b8fa3;
            --accent: #4f8ff7;
            --accent-hover: #3a7ae0;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }
        /* header styles provided by fragments/nav.html */
        /* badge-active provided by fragments/nav.html */
        main { padding: 40px 0 80px; }
        h1 { font-size: 1.5rem; margin-bottom: 4px; }
        .subtitle { color: var(--text-muted); margin-bottom: 24px; font-size: 0.9rem; }

        /* Summary cards */
        .summary-row {
            display: flex; gap: 12px; margin-bottom: 28px; flex-wrap: wrap;
        }
        .summary-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 16px 20px; flex: 1; min-width: 120px;
            text-align: center;
        }
        .summary-number { font-size: 1.8rem; font-weight: 700; }
        .summary-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .summary-card.alert .summary-number { color: var(--error); }
        .summary-card.warn .summary-number { color: var(--warning); }
        .summary-card.ok .summary-number { color: var(--success); }

        /* Sections */
        .section {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; margin-bottom: 24px;
        }
        .section h2 { font-size: 1.1rem; margin-bottom: 16px; color: var(--accent); }
        .section-empty { color: var(--text-muted); font-style: italic; font-size: 0.9rem; }

        /* Lookback toggle */
        .lookback-toggle { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }
        .lookback-btn {
            padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface-2); color: var(--text-muted); cursor: pointer;
            font-size: 0.8rem; font-family: inherit; text-decoration: none;
        }
        .lookback-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .lookback-btn.loading {
            color: var(--accent) !important;
            animation: lookback-pulse 0.5s ease-in-out infinite alternate;
        }
        @keyframes lookback-pulse {
            from { border-color: rgba(79,143,247,0.3); }
            to   { border-color: rgba(79,143,247,1); }
        }

        /* Clickable summary cards */
        .summary-card[data-filter] { cursor: pointer; transition: border-color 0.15s, transform 0.1s; }
        .summary-card[data-filter]:hover { border-color: var(--accent); transform: translateY(-1px); }
        .summary-card.filter-active { border-color: var(--accent); box-shadow: 0 0 0 1px var(--accent); }

        /* Property card filter state */
        .prop-card.filter-hidden { display: none; }

        /* Change cards */
        .change-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .change-card:last-child { border-bottom: none; }
        .change-meta { display: flex; flex-direction: column; }
        .change-permit { font-weight: 500; font-size: 0.95rem; }
        .change-permit a { color: var(--text); text-decoration: none; }
        .change-permit a:hover { color: var(--accent); text-decoration: underline; }
        .change-detail { font-size: 0.8rem; color: var(--text-muted); }
        .status-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        }
        .status-filed { background: rgba(79, 143, 247, 0.15); color: var(--accent); }
        .status-approved { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .status-issued { background: rgba(52, 211, 153, 0.2); color: var(--success); }
        .status-completed { background: rgba(52, 211, 153, 0.3); color: var(--success); }
        .status-expired, .status-cancelled { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .status-activity { background: rgba(79, 143, 247, 0.12); color: var(--accent); }
        .status-on_track { background: rgba(52, 211, 153, 0.12); color: var(--success); }
        .status-slower { background: rgba(251, 191, 36, 0.12); color: var(--warning); }
        .status-behind { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
        .status-at_risk { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .status-arrow { color: var(--text-muted); margin: 0 4px; }

        /* Health bars */
        .health-item {
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .health-item:last-child { border-bottom: none; }
        .health-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .health-label { font-weight: 500; font-size: 0.9rem; }
        .health-label a { color: var(--text); text-decoration: none; }
        .health-label a:hover { color: var(--accent); text-decoration: underline; }
        .health-status {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            padding: 2px 8px; border-radius: 4px;
        }
        .health-on_track { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .health-slower { background: rgba(251, 191, 36, 0.12); color: var(--warning); }
        .health-behind { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
        .health-at_risk { background: rgba(248, 113, 113, 0.25); color: var(--error); }
        .progress-track {
            height: 8px; background: var(--surface-2); border-radius: 4px;
            position: relative; overflow: visible; margin-top: 4px;
        }
        .progress-fill {
            height: 100%; border-radius: 4px; transition: width 0.3s;
        }
        .progress-fill.on_track { background: var(--success); }
        .progress-fill.slower { background: var(--warning); }
        .progress-fill.behind { background: var(--warning); }
        .progress-fill.at_risk { background: var(--error); }
        .health-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        /* Inspection results */
        .insp-pass { color: var(--success); }
        .insp-fail { color: var(--error); }
        .insp-other { color: var(--text-muted); }

        /* Expiring */
        .expire-urgent { color: var(--error); font-weight: 600; }
        .expire-warning { color: var(--warning); }

        /* Onboarding empty state */
        .onboarding {
            text-align: center;
            padding: 48px 24px;
        }
        .onboarding h2 { color: var(--text); font-size: 1.2rem; margin-bottom: 12px; }
        .onboarding p { color: var(--text-muted); margin-bottom: 20px; max-width: 480px; margin-left: auto; margin-right: auto; }
        .onboarding .btn {
            display: inline-block;
            padding: 10px 24px;
            background: var(--accent);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .onboarding .btn:hover { background: var(--accent-hover); }

        /* Reviewed (dismiss) */
        .btn-dismiss {
            background: none; border: 1px solid var(--border); color: var(--text-muted);
            padding: 3px 10px; border-radius: 5px; cursor: pointer;
            font-size: 0.75rem; font-family: inherit; margin-left: 8px;
        }
        .btn-dismiss:hover { border-color: var(--success); color: var(--success); }

        /* Property snapshot grid */
        .property-snapshot-grid {
            display: grid; gap: 16px; grid-template-columns: 1fr;
        }
        @media (min-width: 640px) {
            .property-snapshot-grid { grid-template-columns: 1fr 1fr; }
        }
        .prop-card {
            background: var(--surface-2); border: 1px solid var(--border);
            border-radius: 10px; padding: 16px;
        }
        .prop-card.health-at_risk { border-left: 3px solid var(--error); }
        .prop-card.health-behind { border-left: 3px solid var(--warning); }
        .prop-card.health-slower { border-left: 3px solid rgba(251,191,36,0.5); }
        .prop-card.health-on_track { border-left: 3px solid var(--success); }
        .prop-header {
            display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px;
        }
        .prop-address {
            font-weight: 600; font-size: 1rem; color: var(--text); text-decoration: none;
        }
        .prop-address:hover { color: var(--accent); }
        .health-dot {
            display: inline-block; width: 8px; height: 8px; border-radius: 50%; margin-right: 4px;
        }
        .health-dot.on_track { background: var(--success); }
        .health-dot.slower { background: var(--warning); }
        .health-dot.behind { background: var(--warning); }
        .health-dot.at_risk { background: var(--error); }
        .health-text {
            font-size: 0.7rem; font-weight: 600; text-transform: uppercase;
        }
        .health-text.on_track { color: var(--success); }
        .health-text.slower { color: var(--warning); }
        .health-text.behind { color: var(--warning); }
        .health-text.at_risk { color: var(--error); }
        .prop-health-reason {
            font-size: 0.75rem; color: var(--text-muted); margin-bottom: 6px;
            font-style: italic;
        }
        .prop-card.health-at_risk .prop-health-reason { color: var(--error); opacity: 0.8; }
        .prop-card.health-behind .prop-health-reason { color: var(--warning); opacity: 0.9; }
        .prop-card.health-slower .prop-health-reason { color: var(--warning); opacity: 0.7; }
        .prop-recency { font-size: 0.72rem; margin-bottom: 6px; }
        .prop-recency.fresh { color: var(--success); }
        .prop-recency.stale { color: var(--text-muted); }
        .prop-stats { font-size: 0.8rem; color: var(--text-muted); margin-bottom: 8px; }
        .prop-enforcement { margin-bottom: 8px; }
        .enforcement-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 500;
        }
        .enforcement-badge.clear { background: rgba(52,211,153,0.12); color: var(--success); }
        .enforcement-badge.alert { background: rgba(248,113,113,0.15); color: var(--error); }
        .enforcement-badge.unknown { color: var(--text-muted); font-style: italic; font-size: 0.75rem; }
        .prop-routing { margin-top: 8px; }
        .routing-label { font-size: 0.8rem; color: var(--text); margin-bottom: 4px; }
        .routing-alert { font-size: 0.75rem; margin-top: 4px; }
        .routing-alert.stalled { color: var(--error); }
        .routing-alert.held { color: var(--warning); }
        .routing-pending { font-size: 0.75rem; color: var(--text-muted); margin-top: 4px; }
        .routing-velocity { font-size: 0.7rem; color: var(--text-muted); margin-top: 4px; font-style: italic; }
    </style>
</head>
<body>
    {% include 'fragments/nav.html' %}

    <main>
        <div class="container">
            <h1>Good Morning{% if user.display_name %}, {{ user.display_name }}{% endif %}</h1>
            <p class="subtitle">
                {% if brief.property_synopsis %}
                    Monitoring <strong>{{ brief.property_synopsis.address }}</strong>
                    {% if brief.property_synopsis.neighborhood %} &middot; {{ brief.property_synopsis.neighborhood }}{% endif %}
                    &middot;
                {% endif %}
                {{ brief.lookback_days }} day{{ 's' if brief.lookback_days > 1 else '' }} lookback
                {% if brief.last_refresh %}
                    &middot; Data as of {{ brief.last_refresh.last_success_date }}
                {% endif %}
            </p>
            {% if brief.last_refresh and brief.last_refresh.is_stale %}
            <div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;padding:10px 16px;margin-bottom:16px;font-size:0.85rem;color:var(--warning);">
                &#9888; Data may be incomplete &mdash; last refresh was {{ brief.last_refresh.hours_ago|int }} hours ago.
                {% if brief.last_refresh.was_catchup %}Some changes were recovered via backfill.{% endif %}
            </div>
            {% endif %}

            <!-- Lookback toggle (always visible at top) -->
            <div class="lookback-toggle">
                <a href="/brief?lookback=1" class="lookback-btn {{ 'active' if brief.lookback_days == 1 else '' }}">Today</a>
                <a href="/brief?lookback=7" class="lookback-btn {{ 'active' if brief.lookback_days == 7 else '' }}">Last 7 days</a>
                <a href="/brief?lookback=30" class="lookback-btn {{ 'active' if brief.lookback_days == 30 else '' }}">Last 30 days</a>
                <a href="/brief?lookback=90" class="lookback-btn {{ 'active' if brief.lookback_days == 90 else '' }}">Last 90 days</a>
            </div>

            {% if brief.property_synopsis %}
            <!-- Property Synopsis -->
            <div class="section" style="margin-bottom:28px;">
                <h2>Your Property</h2>
                <div class="summary-row" style="margin-bottom:16px;">
                    <div class="summary-card">
                        <div class="summary-number">{{ brief.property_synopsis.total_permits }}</div>
                        <div class="summary-label">Total Permits</div>
                    </div>
                    <div class="summary-card {{ 'ok' if brief.property_synopsis.active_count > 0 else '' }}">
                        <div class="summary-number">{{ brief.property_synopsis.active_count }}</div>
                        <div class="summary-label">Active</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">{{ brief.property_synopsis.completed_count }}</div>
                        <div class="summary-label">Completed</div>
                    </div>
                </div>
                {% if brief.property_synopsis.latest_permit %}
                <div style="margin-bottom:12px;">
                    <span style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;">Most Recent</span>
                    <div style="margin-top:4px;">
                        <a href="/?q={{ brief.property_synopsis.latest_permit.permit_number }}"
                           style="color:var(--accent);text-decoration:none;font-weight:500;">
                            {{ brief.property_synopsis.latest_permit.permit_number }}
                        </a>
                        &middot;
                        <span class="status-badge status-{{ brief.property_synopsis.latest_permit.status|lower }}">
                            {{ brief.property_synopsis.latest_permit.status }}
                        </span>
                        &middot; {{ brief.property_synopsis.latest_permit.type }}
                        {% if brief.property_synopsis.latest_permit.filed_date %}
                        &middot; Filed {{ brief.property_synopsis.latest_permit.filed_date }}
                        {% endif %}
                    </div>
                    {% if brief.property_synopsis.latest_permit.description %}
                    <div style="font-size:0.85rem;color:var(--text-muted);margin-top:2px;">
                        {{ brief.property_synopsis.latest_permit.description }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% if brief.property_synopsis.top_types %}
                <div style="font-size:0.8rem;color:var(--text-muted);">
                    <span style="text-transform:uppercase;">Permit Types:</span>
                    {% for ptype, count in brief.property_synopsis.top_types %}
                        {{ ptype }} ({{ count }}){% if not loop.last %},{% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                {% if brief.property_synopsis.block and brief.property_synopsis.lot %}
                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">
                    Block {{ brief.property_synopsis.block }}, Lot {{ brief.property_synopsis.lot }}
                    {% if brief.property_synopsis.earliest_date and brief.property_synopsis.latest_date %}
                    &middot; Permit history: {{ brief.property_synopsis.earliest_date }} &ndash; {{ brief.property_synopsis.latest_date }}
                    {% endif %}
                </div>
                <div style="margin-top:12px;">
                    <a href="/report/{{ brief.property_synopsis.block }}/{{ brief.property_synopsis.lot }}"
                       style="display:inline-block;padding:8px 18px;background:var(--accent);color:#fff;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.85rem;">
                        View Property Report &rarr;
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if brief.summary.total_watches == 0 and not brief.property_synopsis %}
            <!-- Onboarding: no watches yet -->
            <div class="section onboarding">
                <h2>Your morning brief is ready to go</h2>
                <p>
                    Start watching permits, addresses, or neighborhoods and you'll see
                    status changes, inspection results, and health alerts right here every morning.
                </p>
                <a href="/" class="btn">Search permits to start watching</a>
            </div>
            {% elif brief.summary.total_watches > 0 or brief.property_synopsis %}

            <!-- Summary cards (clickable — filter property grid) -->
            <div class="summary-row">
                <div class="summary-card" data-filter="all">
                    <div class="summary-number">{{ brief.summary.total_properties or brief.summary.total_watches }}</div>
                    <div class="summary-label">{{ 'Property' if (brief.summary.total_properties or brief.summary.total_watches) == 1 else 'Properties' }}</div>
                </div>
                <div class="summary-card {{ 'ok' if brief.summary.changes_count > 0 else '' }}" data-filter="changed">
                    <div class="summary-number">{{ brief.summary.changes_count }}</div>
                    <div class="summary-label">Changed</div>
                </div>
                <div class="summary-card {{ 'alert' if brief.summary.get('enforcement_count', 0) > 0 else '' }}" data-filter="enforcement">
                    <div class="summary-number">{{ brief.summary.get('enforcement_count', 0) }}</div>
                    <div class="summary-label">Enforcement</div>
                </div>
                <div class="summary-card {{ 'warn' if brief.summary.inspections_count > 0 else '' }}" data-filter="inspections">
                    <div class="summary-number">{{ brief.summary.inspections_count }}</div>
                    <div class="summary-label">Inspections</div>
                </div>
                <div class="summary-card {{ 'warn' if brief.summary.expiring_count > 0 else '' }}" data-filter="expiring">
                    <div class="summary-number">{{ brief.summary.expiring_count }}</div>
                    <div class="summary-label">Expiring</div>
                </div>
            </div>

            <!-- Section 1: What Changed -->
            <div class="section" id="section-changes">
                <h2>What Changed</h2>
                {% if brief.changes %}
                {% for c in brief.changes %}
                <div class="change-card" id="change-{{ loop.index }}">
                    {% if c.change_type == 'activity' %}
                    {# Property-level activity (from SODA status_date, not permit_changes log) #}
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="{{ c.label|default('') and '/?q=' + (c.street_number + ' ' + c.street_name)|urlencode or '#' }}" title="Look up property">{{ c.label }}</a>
                        </span>
                        <span class="change-detail">
                            {% if c.permit_number %}{{ c.permit_number }} &middot; {% endif %}
                            {% if c.latest_permit_status %}{{ c.latest_permit_status|upper }}{% endif %}
                            {% if c.permit_type %} &middot; {{ c.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                        {% if c.latest_permit_status %}
                        <span class="status-badge status-{{ c.latest_permit_status|lower }}" style="font-size:0.65rem;">{{ c.latest_permit_status }}</span>
                        {% endif %}
                        <span style="font-size:0.65rem;color:var(--text-muted);">{{ c.days_since_activity }}d ago</span>
                        <span style="font-size:0.65rem;color:var(--text-muted);">&middot; {{ c.active_permits }} active of {{ c.total_permits }}</span>
                        <button class="btn-dismiss" onclick="this.closest('.change-card').style.opacity='0.3';this.remove();" title="Mark reviewed">&#10003;</button>
                    </div>
                    {% else %}
                    {# Permit-level status transition (from permit_changes detection log) #}
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ c.permit_number }}" title="Look up permit details">{{ c.label or c.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ c.permit_number }}
                            {% if c.street_number %} &middot; {{ c.street_number }} {{ c.street_name }}{% endif %}
                            {% if c.neighborhood %} &middot; {{ c.neighborhood }}{% endif %}
                            {% if c.permit_type %} &middot; {{ c.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div style="display:flex;align-items:center;gap:6px;flex-wrap:wrap;">
                        {% if c.old_status %}
                        <span class="status-badge status-{{ c.old_status|lower }}">{{ c.old_status }}</span>
                        <span class="status-arrow">&rarr;</span>
                        {% endif %}
                        <span class="status-badge status-{{ c.new_status|lower }}">{{ c.new_status }}</span>
                        {% if c.change_date %}
                        <span style="font-size:0.65rem;color:var(--text-muted);">{{ c.change_date }}</span>
                        {% endif %}
                        <button class="btn-dismiss" onclick="this.closest('.change-card').style.opacity='0.3';this.remove();" title="Mark reviewed">&#10003;</button>
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">
                    No status changes on your watched items in this period.
                    {% if brief.lookback_days == 1 %}Try <a href="/brief?lookback=7" style="color:var(--accent);">last 7 days</a> for a wider view.{% endif %}
                </p>
                {% endif %}
            </div>

            <!-- Section 1.5: Plan Review Activity -->
            {% if brief.plan_reviews %}
            <div class="section">
                <h2>Plan Review Activity</h2>
                {% for pr in brief.plan_reviews %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ pr.permit_number }}">{{ pr.label or pr.permit_number }}</a>
                        </span>
                        <span class="change-date">{{ pr.change_date }}</span>
                    </div>
                    <div class="change-detail">
                        <strong>{{ pr.station }}</strong>
                        {% if pr.department %}<span style="color:var(--text-muted);"> ({{ pr.department }})</span>{% endif %}
                        {% if pr.reviewer %} &middot; {{ pr.reviewer }}{% endif %}
                    </div>
                    <div>
                        {% if pr.result == 'Approved' %}
                        <span class="status-badge" style="background:#059669;color:#fff;">{{ pr.result }}</span>
                        {% elif pr.result == 'Issued Comments' %}
                        <span class="status-badge" style="background:#d97706;color:#fff;">{{ pr.result }}</span>
                        {% elif pr.result %}
                        <span class="status-badge" style="background:#6b7280;color:#fff;">{{ pr.result }}</span>
                        {% else %}
                        <span class="status-badge" style="background:#3b82f6;color:#fff;">Routed</span>
                        {% endif %}
                    </div>
                    {% if pr.notes %}
                    <div style="margin-top:4px;font-size:0.85rem;color:var(--text-muted);">{{ pr.notes }}</div>
                    {% endif %}
                    {# Routing context + velocity #}
                    {% if pr.routing_completion_pct is defined and pr.routing_completion_pct is not none %}
                    <div style="margin-top:6px;">
                        <div style="display:flex;align-items:center;gap:8px;">
                            <div class="progress-track" style="flex:1;height:6px;">
                                <div class="progress-fill {{ 'on_track' if pr.routing_completion_pct >= 50 else 'slower' }}"
                                     style="width:{{ pr.routing_completion_pct }}%"></div>
                            </div>
                            <span style="font-size:0.75rem;color:var(--text-muted);white-space:nowrap;">
                                {{ pr.routing_completed_stations }}/{{ pr.routing_total_stations }} stations
                            </span>
                        </div>
                        {% if pr.station_typical_label %}
                        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;">
                            {{ pr.station }} typically takes {{ pr.station_typical_label }}
                        </div>
                        {% endif %}
                        {% if pr.routing_pending_stations %}
                        <div style="font-size:0.7rem;color:var(--text-muted);margin-top:2px;">
                            Waiting on: {{ pr.routing_pending_stations | join(', ') }}
                        </div>
                        {% endif %}
                    </div>
                    {% endif %}
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {# ===== Your Properties — always visible when property cards exist ===== #}
            {% if brief.property_cards %}
            <div class="section" id="section-properties" style="margin-bottom:28px;">
                <h2>Your Properties</h2>
                <div class="property-snapshot-grid" id="property-grid">
                    {% for prop in brief.property_cards %}
                    <div class="prop-card health-{{ prop.worst_health }}"
                         {% if prop.days_since_activity is not none and prop.days_since_activity <= brief.lookback_days %}data-changed="true"{% endif %}
                         {% if prop.enforcement_total and prop.enforcement_total > 0 %}data-enforcement="true"{% endif %}
                         {% if prop.worst_health in ('at_risk', 'behind') %}data-at-risk="true"{% endif %}>
                        <div class="prop-header">
                            <a href="{{ prop.search_url }}" class="prop-address">
                                {{ prop.label or prop.address }}
                            </a>
                            <span class="health-indicator">
                                <span class="health-dot {{ prop.worst_health }}"></span>
                                <span class="health-text {{ prop.worst_health }}">{{ prop.worst_health | replace('_', ' ') }}</span>
                            </span>
                        </div>
                        {% if prop.health_reason and prop.worst_health != 'on_track' %}
                        <div class="prop-health-reason">{{ prop.health_reason }}</div>
                        {% endif %}
                        {% if prop.days_since_activity is not none %}
                        <div class="prop-recency {% if prop.days_since_activity <= 7 %}fresh{% elif prop.days_since_activity <= 30 %}stale{% else %}stale{% endif %}">
                            {% if prop.days_since_activity == 0 %}&#x1f7e2; Activity today
                            {% elif prop.days_since_activity == 1 %}&#x1f7e2; Activity yesterday
                            {% elif prop.days_since_activity <= 7 %}&#x1f7e2; Activity {{ prop.days_since_activity }}d ago
                            {% elif prop.days_since_activity <= 30 %}&#x25cb; Last activity {{ prop.days_since_activity }}d ago
                            {% else %}&#x25cb; Last activity {{ prop.days_since_activity }}d ago
                            {% endif %}
                        </div>
                        {% endif %}
                        <div class="prop-stats">
                            {{ prop.active_permits }} active of {{ prop.total_permits }} permits
                            {% if prop.neighborhood %} &middot; {{ prop.neighborhood }}{% endif %}
                            {% if prop.parcels_display %} &middot; {{ prop.parcels_display }}{% endif %}
                        </div>
                        {# Enforcement badge #}
                        <div class="prop-enforcement">
                            {% if prop.enforcement_total is none %}
                            <span class="enforcement-badge unknown">&mdash; Enforcement data not available</span>
                            {% elif prop.enforcement_total == 0 %}
                            <span class="enforcement-badge clear">&#10003; No open violations or complaints</span>
                            {% else %}
                            <span class="enforcement-badge alert">&#9888;
                                {% if prop.open_violations %}{{ prop.open_violations }} violation{{ 's' if prop.open_violations != 1 else '' }}{% endif %}{% if prop.open_violations and prop.open_complaints %} + {% endif %}{% if prop.open_complaints %}{{ prop.open_complaints }} complaint{{ 's' if prop.open_complaints != 1 else '' }}{% endif %}
                            </span>
                            {% endif %}
                        </div>
                        {# Routing progress #}
                        {% if prop.routing %}
                        <div class="prop-routing">
                            <div class="routing-label">
                                Plan Review: {{ prop.routing.completed_stations }} of {{ prop.routing.total_stations }} stations ({{ prop.routing.completion_pct }}%)
                            </div>
                            <div class="progress-track">
                                <div class="progress-fill {{ 'on_track' if prop.routing.completion_pct >= 50 else 'slower' }}"
                                     style="width:{{ prop.routing.completion_pct }}%"></div>
                            </div>
                            {% if prop.routing.stalled_stations %}
                            <div class="routing-alert stalled">&#9888; Stalled: {{ prop.routing.stalled_stations | join(', ') }}</div>
                            {% endif %}
                            {% if prop.routing.held_stations %}
                            <div class="routing-alert held">&#9201; Held: {{ prop.routing.held_stations | join(', ') }}</div>
                            {% endif %}
                            {% if prop.routing.pending_station_names %}
                            <div class="routing-pending">Waiting on: {{ prop.routing.pending_station_names | join(', ') }}</div>
                            {% endif %}
                            {% if prop.routing.velocity %}
                            <div class="routing-velocity">
                                {% for v in prop.routing.velocity %}{{ v.station }}: typically {{ v.typical }}{% if not loop.last %} &middot; {% endif %}{% endfor %}
                            </div>
                            {% endif %}
                        </div>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% else %}
            {# Fallback if no property cards — show simplified quiet message #}
            {% set all_empty = not brief.changes and not brief.health and not brief.inspections and not brief.new_filings and not brief.team_activity and not brief.expiring and not brief.regulatory_alerts %}
            {% if all_empty %}
            <div style="background: rgba(79, 143, 247, 0.06); border: 1px solid rgba(79, 143, 247, 0.2); border-radius: 10px; padding: 24px; margin-bottom: 24px; text-align: center;">
                <div style="font-size: 1.5rem; margin-bottom: 8px;">&#x2705;</div>
                <div style="font-weight: 600; margin-bottom: 6px;">All quiet on your watched items</div>
                <div style="color: var(--text-muted); font-size: 0.9rem; max-width: 480px; margin: 0 auto;">
                    {% if brief.lookback_days == 1 %}No activity today. Try <a href="/brief?lookback=7" style="color:var(--accent);">last 7 days</a> or <a href="/brief?lookback=30" style="color:var(--accent);">last 30 days</a> for a wider view.{% elif brief.lookback_days < 90 %}No activity in the last {{ brief.lookback_days }} days. {% if brief.lookback_days <= 30 %}Try <a href="/brief?lookback=90" style="color:var(--accent);">last 90 days</a>.{% endif %}{% else %}No activity in the last 90 days.{% endif %}
                </div>
                <div style="margin-top: 16px;">
                    <a href="/" style="color: var(--accent); text-decoration: none; font-size: 0.9rem;">Search for permits to watch &rarr;</a>
                </div>
            </div>
            {% endif %}
            {% endif %}

            <!-- Section 2: Permit Health -->
            <div class="section">
                <h2>Permit Health</h2>
                {% if brief.health %}
                {% for h in brief.health %}
                <div class="health-item">
                    <div class="health-header">
                        <span class="health-label">
                            <a href="/?q={{ h.permit_number }}" title="Look up permit details">{{ h.label or h.permit_number }}</a>
                        </span>
                        <span class="health-status health-{{ h.status }}">{{ h.status|replace('_', ' ') }}</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill {{ h.status }}"
                             style="width: {{ [h.pct_of_typical, 100] | min }}%"></div>
                    </div>
                    <div class="health-detail">
                        {{ h.elapsed_days }} days elapsed &middot;
                        typical: {{ h.p50 }} days &middot;
                        {{ h.pct_of_typical }}% of typical
                        ({{ h.sample_size }} similar permits)
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">
                    No active watched permits to track. Watch a specific permit number to see health tracking here.
                </p>
                {% endif %}
            </div>

            <!-- Section 3: Inspection Results -->
            <div class="section" id="section-inspections">
                <h2>Inspection Results</h2>
                {% if brief.inspections %}
                {% for insp in brief.inspections %}
                <div class="change-card" id="insp-{{ loop.index }}">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ insp.permit_number }}" title="Look up permit details">{{ insp.label or insp.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ insp.description or 'Inspection' }}
                            {% if insp.inspector %} &middot; {{ insp.inspector }}{% endif %}
                            &middot; {{ insp.date }}
                        </span>
                    </div>
                    <div style="display:flex;align-items:center;">
                        <span class="status-badge {% if insp.is_pass %}status-approved{% elif insp.is_fail %}status-expired{% else %}{% endif %}">
                            {{ insp.result or 'Pending' }}
                        </span>
                        <button class="btn-dismiss" onclick="this.closest('.change-card').style.opacity='0.3';this.remove();" title="Mark reviewed">&#10003;</button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">
                    No recent inspections on your watched permits.
                    {% if brief.lookback_days == 1 %}Try <a href="/brief?lookback=7" style="color:var(--accent);">last 7 days</a>.{% endif %}
                </p>
                {% endif %}
            </div>

            <!-- Section 4: New Filings -->
            <div class="section">
                <h2>New Filings at Watched Locations</h2>
                {% if brief.new_filings %}
                {% for f in brief.new_filings %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ f.permit_number }}" title="Look up permit details">{{ f.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ f.street_number }} {{ f.street_name }}
                            {% if f.neighborhood %} &middot; {{ f.neighborhood }}{% endif %}
                            {% if f.permit_type %} &middot; {{ f.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge status-filed">new</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No new permits filed at your watched addresses or parcels.</p>
                {% endif %}
            </div>

            <!-- Section 5: Team Activity -->
            <div class="section">
                <h2>Team Activity</h2>
                {% if brief.team_activity %}
                {% for t in brief.team_activity %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ t.entity_name }} ({{ t.role }})</span>
                        <span class="change-detail">
                            <a href="/?q={{ t.permit_number }}" style="color:var(--text-muted);text-decoration:none;">{{ t.permit_number }}</a> &middot;
                            {{ t.street_number }} {{ t.street_name }}
                            {% if t.neighborhood %} &middot; {{ t.neighborhood }}{% endif %}
                            {% if t.permit_type %} &middot; {{ t.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge status-{{ t.status|lower }}">{{ t.status }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No new activity from your watched contractors, architects, or consultants.</p>
                {% endif %}
            </div>

            <!-- Section 6: Expiring Permits -->
            <div class="section" id="section-expiring">
                <h2>Expiring Permits</h2>
                {% if brief.expiring %}
                {% for e in brief.expiring %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ e.permit_number }}" title="Look up permit details">{{ e.label or e.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ e.street_number }} {{ e.street_name }}
                            {% if e.neighborhood %} &middot; {{ e.neighborhood }}{% endif %}
                            &middot; Issued: {{ e.issued_date }}
                        </span>
                    </div>
                    <div>
                        {% if e.is_expired %}
                        <span class="expire-urgent">EXPIRED ({{ -e.expires_in }} days ago)</span>
                        {% else %}
                        <span class="expire-warning">Expires in {{ e.expires_in }} days</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No permits approaching their Table B expiration deadline.</p>
                {% endif %}
            </div>

            <!-- Section 7: Regulatory Alerts -->
            {% if brief.regulatory_alerts %}
            <div class="section">
                <h2>Regulatory Watch</h2>
                {% for a in brief.regulatory_alerts %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ a.title }}</span>
                        <span class="change-detail">
                            {{ a.source_type | replace('_', ' ') | title }} &mdash; {{ a.source_id }}
                            {% if a.filed_date %} &middot; Filed {{ a.filed_date }}{% endif %}
                        </span>
                    </div>
                    <div style="display:flex;gap:6px;align-items:center;">
                        <span class="badge-{{ a.impact_level }}" style="font-size:0.7rem;padding:1px 6px;border-radius:3px;text-transform:uppercase;font-weight:600;
                            {% if a.impact_level == 'high' %}background:rgba(248,113,113,0.15);color:#f87171;
                            {% elif a.impact_level == 'moderate' %}background:rgba(251,191,36,0.15);color:#fbbf24;
                            {% else %}background:rgba(79,143,247,0.12);color:#4f8ff7;{% endif %}">{{ a.impact_level }}</span>
                        <span style="font-size:0.75rem;color:var(--text-muted);">{{ a.status }}</span>
                    </div>
                </div>
                {% endfor %}
                {% if g and g.user and g.user.is_admin %}
                <div style="text-align:right;margin-top:8px;">
                    <a href="/admin/regulatory-watch" style="font-size:0.8rem;color:var(--accent);">Manage watch items &rarr;</a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            <!-- Email preferences hint -->
            <div style="text-align:center;margin-top:16px;">
                <a href="/account" style="color:var(--text-muted);font-size:0.8rem;text-decoration:none;">
                    Manage email preferences &middot; Get this brief in your inbox
                </a>
            </div>

            {% endif %}{# end of total_watches > 0 or property_synopsis #}
        </div>
    </main>
    {% include 'fragments/feedback_widget.html' %}
<script>
// Lookback button loading pulse on click
document.querySelectorAll('.lookback-btn').forEach(function(btn) {
    btn.addEventListener('click', function() {
        if (this.classList.contains('active')) return;
        this.classList.add('loading');
    });
});

// Clickable summary cards — filter property grid
(function() {
    var activeFilter = null;
    var cards = document.querySelectorAll('.summary-card[data-filter]');
    var grid = document.getElementById('property-grid');
    if (!grid) return;
    var props = grid.querySelectorAll('.prop-card');

    function applyFilter(filterName) {
        if (filterName === activeFilter) {
            // Toggle off — show all
            activeFilter = null;
            cards.forEach(function(c) { c.classList.remove('filter-active'); });
            props.forEach(function(p) { p.classList.remove('filter-hidden'); });
            return;
        }
        activeFilter = filterName;
        cards.forEach(function(c) { c.classList.toggle('filter-active', c.dataset.filter === filterName); });
        props.forEach(function(p) {
            var show = false;
            if (filterName === 'all') show = true;
            else if (filterName === 'changed') show = p.hasAttribute('data-changed');
            else if (filterName === 'enforcement') show = p.hasAttribute('data-enforcement');
            else if (filterName === 'at-risk') show = p.hasAttribute('data-at-risk');
            else show = true;
            p.classList.toggle('filter-hidden', !show);
        });
        // Scroll to property grid
        var section = document.getElementById('section-properties');
        if (section) section.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    cards.forEach(function(card) {
        card.addEventListener('click', function() {
            applyFilter(this.dataset.filter);
        });
    });
})();
</script>
</body>
</html>
