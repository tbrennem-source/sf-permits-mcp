<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Morning Brief â€” sfpermits.ai</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #252834;
            --border: #333749;
            --text: #e4e6eb;
            --text-muted: #8b8fa3;
            --accent: #4f8ff7;
            --accent-hover: #3a7ae0;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }
        header { border-bottom: 1px solid var(--border); padding: 20px 0; }
        header .container { display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.4rem; font-weight: 700; color: var(--accent); text-decoration: none; }
        .logo span { color: var(--text-muted); font-weight: 400; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .badge {
            font-size: 0.7rem; background: var(--surface-2); color: var(--text-muted);
            padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border);
            text-decoration: none; cursor: pointer; font-family: inherit;
        }
        .badge:hover { color: var(--text); border-color: var(--text-muted); }
        main { padding: 40px 0 80px; }
        h1 { font-size: 1.5rem; margin-bottom: 4px; }
        .subtitle { color: var(--text-muted); margin-bottom: 24px; font-size: 0.9rem; }

        /* Summary cards */
        .summary-row {
            display: flex; gap: 12px; margin-bottom: 28px; flex-wrap: wrap;
        }
        .summary-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 16px 20px; flex: 1; min-width: 120px;
            text-align: center;
        }
        .summary-number { font-size: 1.8rem; font-weight: 700; }
        .summary-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .summary-card.alert .summary-number { color: var(--error); }
        .summary-card.warn .summary-number { color: var(--warning); }
        .summary-card.ok .summary-number { color: var(--success); }

        /* Sections */
        .section {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; margin-bottom: 24px;
        }
        .section h2 { font-size: 1.1rem; margin-bottom: 16px; color: var(--accent); }
        .section-empty { color: var(--text-muted); font-style: italic; }

        /* Lookback toggle */
        .lookback-toggle { display: flex; gap: 8px; margin-bottom: 20px; }
        .lookback-btn {
            padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface-2); color: var(--text-muted); cursor: pointer;
            font-size: 0.8rem; font-family: inherit; text-decoration: none;
        }
        .lookback-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* Change cards */
        .change-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .change-card:last-child { border-bottom: none; }
        .change-meta { display: flex; flex-direction: column; }
        .change-permit { font-weight: 500; font-size: 0.95rem; }
        .change-detail { font-size: 0.8rem; color: var(--text-muted); }
        .status-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        }
        .status-filed { background: rgba(79, 143, 247, 0.15); color: var(--accent); }
        .status-approved { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .status-issued { background: rgba(52, 211, 153, 0.2); color: var(--success); }
        .status-completed { background: rgba(52, 211, 153, 0.3); color: var(--success); }
        .status-expired, .status-cancelled { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .status-arrow { color: var(--text-muted); margin: 0 4px; }

        /* Health bars */
        .health-item {
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .health-item:last-child { border-bottom: none; }
        .health-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .health-label { font-weight: 500; font-size: 0.9rem; }
        .health-status {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            padding: 2px 8px; border-radius: 4px;
        }
        .health-on_track { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .health-slower { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
        .health-behind { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .health-at_risk { background: rgba(248, 113, 113, 0.25); color: var(--error); }
        .progress-track {
            height: 8px; background: var(--surface-2); border-radius: 4px;
            position: relative; overflow: visible; margin-top: 4px;
        }
        .progress-fill {
            height: 100%; border-radius: 4px; transition: width 0.3s;
        }
        .progress-fill.on_track { background: var(--success); }
        .progress-fill.slower { background: var(--warning); }
        .progress-fill.behind { background: var(--error); }
        .progress-fill.at_risk { background: var(--error); }
        .health-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        /* Inspection results */
        .insp-pass { color: var(--success); }
        .insp-fail { color: var(--error); }
        .insp-other { color: var(--text-muted); }

        /* Expiring */
        .expire-urgent { color: var(--error); font-weight: 600; }
        .expire-warning { color: var(--warning); }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <a href="/" class="logo">sfpermits<span>.ai</span></a>
            <div class="header-right">
                <a href="/brief" class="badge" style="background:var(--accent);color:#fff;border-color:var(--accent);">Morning Brief</a>
                <a href="/account" class="badge">{{ user.display_name or user.email }}</a>
                <form method="POST" action="/auth/logout" style="display:inline;">
                    <button class="badge" type="submit">Logout</button>
                </form>
            </div>
        </div>
    </header>

    <main>
        <div class="container">
            <h1>Good Morning{% if user.display_name %}, {{ user.display_name }}{% endif %}</h1>
            <p class="subtitle">
                {{ brief.lookback_days }} day{{ 's' if brief.lookback_days > 1 else '' }} lookback
            </p>

            <!-- Lookback toggle -->
            <div class="lookback-toggle">
                <a href="/brief?lookback=1" class="lookback-btn {{ 'active' if brief.lookback_days == 1 else '' }}">Today</a>
                <a href="/brief?lookback=7" class="lookback-btn {{ 'active' if brief.lookback_days == 7 else '' }}">Last 7 days</a>
                <a href="/brief?lookback=30" class="lookback-btn {{ 'active' if brief.lookback_days == 30 else '' }}">Last 30 days</a>
            </div>

            <!-- Summary cards -->
            <div class="summary-row">
                <div class="summary-card">
                    <div class="summary-number">{{ brief.summary.total_watches }}</div>
                    <div class="summary-label">Watching</div>
                </div>
                <div class="summary-card {{ 'ok' if brief.summary.changes_count > 0 else '' }}">
                    <div class="summary-number">{{ brief.summary.changes_count }}</div>
                    <div class="summary-label">Changed</div>
                </div>
                <div class="summary-card {{ 'alert' if brief.summary.at_risk_count > 0 else '' }}">
                    <div class="summary-number">{{ brief.summary.at_risk_count }}</div>
                    <div class="summary-label">At Risk</div>
                </div>
                <div class="summary-card {{ 'warn' if brief.summary.inspections_count > 0 else '' }}">
                    <div class="summary-number">{{ brief.summary.inspections_count }}</div>
                    <div class="summary-label">Inspections</div>
                </div>
                <div class="summary-card {{ 'warn' if brief.summary.expiring_count > 0 else '' }}">
                    <div class="summary-number">{{ brief.summary.expiring_count }}</div>
                    <div class="summary-label">Expiring</div>
                </div>
            </div>

            <!-- Section 1: What Changed -->
            <div class="section">
                <h2>What Changed</h2>
                {% if brief.changes %}
                {% for c in brief.changes %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ c.label or c.permit_number }}</span>
                        <span class="change-detail">
                            {{ c.street_number }} {{ c.street_name }}
                            {% if c.neighborhood %} &middot; {{ c.neighborhood }}{% endif %}
                            {% if c.permit_type %} &middot; {{ c.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        {% if c.old_status %}
                        <span class="status-badge status-{{ c.old_status|lower }}">{{ c.old_status }}</span>
                        <span class="status-arrow">&rarr;</span>
                        {% endif %}
                        <span class="status-badge status-{{ c.new_status|lower }}">{{ c.new_status }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No status changes on your watched items in this period.</p>
                {% endif %}
            </div>

            <!-- Section 2: Permit Health -->
            <div class="section">
                <h2>Permit Health</h2>
                {% if brief.health %}
                {% for h in brief.health %}
                <div class="health-item">
                    <div class="health-header">
                        <span class="health-label">{{ h.label or h.permit_number }}</span>
                        <span class="health-status health-{{ h.status }}">{{ h.status|replace('_', ' ') }}</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill {{ h.status }}"
                             style="width: {{ [h.pct_of_typical, 100] | min }}%"></div>
                    </div>
                    <div class="health-detail">
                        {{ h.elapsed_days }} days elapsed &middot;
                        typical: {{ h.p50 }} days &middot;
                        {{ h.pct_of_typical }}% of typical
                        ({{ h.sample_size }} similar permits)
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No active watched permits to track.</p>
                {% endif %}
            </div>

            <!-- Section 3: Inspection Results -->
            <div class="section">
                <h2>Inspection Results</h2>
                {% if brief.inspections %}
                {% for insp in brief.inspections %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ insp.label or insp.permit_number }}</span>
                        <span class="change-detail">
                            {{ insp.description or 'Inspection' }}
                            {% if insp.inspector %} &middot; {{ insp.inspector }}{% endif %}
                            &middot; {{ insp.date }}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge {% if insp.is_pass %}status-approved{% elif insp.is_fail %}status-expired{% else %}{% endif %}">
                            {{ insp.result or 'Pending' }}
                        </span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No recent inspections on your watched permits.</p>
                {% endif %}
            </div>

            <!-- Section 4: New Filings -->
            {% if brief.new_filings %}
            <div class="section">
                <h2>New Filings at Watched Locations</h2>
                {% for f in brief.new_filings %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ f.permit_number }}</span>
                        <span class="change-detail">
                            {{ f.street_number }} {{ f.street_name }}
                            {% if f.neighborhood %} &middot; {{ f.neighborhood }}{% endif %}
                            {% if f.permit_type %} &middot; {{ f.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge status-filed">new</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Section 5: Team Activity -->
            {% if brief.team_activity %}
            <div class="section">
                <h2>Team Activity</h2>
                {% for t in brief.team_activity %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ t.entity_name }} ({{ t.role }})</span>
                        <span class="change-detail">
                            {{ t.permit_number }} &middot;
                            {{ t.street_number }} {{ t.street_name }}
                            {% if t.neighborhood %} &middot; {{ t.neighborhood }}{% endif %}
                            {% if t.permit_type %} &middot; {{ t.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge status-{{ t.status|lower }}">{{ t.status }}</span>
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            <!-- Section 6: Expiring Permits -->
            {% if brief.expiring %}
            <div class="section">
                <h2>Expiring Permits</h2>
                {% for e in brief.expiring %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ e.label or e.permit_number }}</span>
                        <span class="change-detail">
                            {{ e.street_number }} {{ e.street_name }}
                            {% if e.neighborhood %} &middot; {{ e.neighborhood }}{% endif %}
                            &middot; Issued: {{ e.issued_date }}
                        </span>
                    </div>
                    <div>
                        {% if e.is_expired %}
                        <span class="expire-urgent">EXPIRED ({{ -e.expires_in }} days ago)</span>
                        {% else %}
                        <span class="expire-warning">Expires in {{ e.expires_in }} days</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

        </div>
    </main>
</body>
</html>
