<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Morning Brief — sfpermits.ai</title>
    <script src="https://unpkg.com/htmx.org@2.0.4"></script>
    <style>
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #252834;
            --border: #333749;
            --text: #e4e6eb;
            --text-muted: #8b8fa3;
            --accent: #4f8ff7;
            --accent-hover: #3a7ae0;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 900px; margin: 0 auto; padding: 0 24px; }
        header { border-bottom: 1px solid var(--border); padding: 20px 0; }
        header .container { display: flex; align-items: center; justify-content: space-between; }
        .logo { font-size: 1.4rem; font-weight: 700; color: var(--accent); text-decoration: none; }
        .logo span { color: var(--text-muted); font-weight: 400; }
        .header-right { display: flex; align-items: center; gap: 10px; }
        .badge {
            font-size: 0.7rem; background: var(--surface-2); color: var(--text-muted);
            padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border);
            text-decoration: none; cursor: pointer; font-family: inherit;
        }
        .badge:hover { color: var(--text); border-color: var(--text-muted); }
        .badge-active { background: var(--accent); color: #fff; border-color: var(--accent); }
        main { padding: 40px 0 80px; }
        h1 { font-size: 1.5rem; margin-bottom: 4px; }
        .subtitle { color: var(--text-muted); margin-bottom: 24px; font-size: 0.9rem; }

        /* Summary cards */
        .summary-row {
            display: flex; gap: 12px; margin-bottom: 28px; flex-wrap: wrap;
        }
        .summary-card {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 10px; padding: 16px 20px; flex: 1; min-width: 120px;
            text-align: center;
        }
        .summary-number { font-size: 1.8rem; font-weight: 700; }
        .summary-label { font-size: 0.75rem; color: var(--text-muted); text-transform: uppercase; }
        .summary-card.alert .summary-number { color: var(--error); }
        .summary-card.warn .summary-number { color: var(--warning); }
        .summary-card.ok .summary-number { color: var(--success); }

        /* Sections */
        .section {
            background: var(--surface); border: 1px solid var(--border);
            border-radius: 12px; padding: 24px; margin-bottom: 24px;
        }
        .section h2 { font-size: 1.1rem; margin-bottom: 16px; color: var(--accent); }
        .section-empty { color: var(--text-muted); font-style: italic; font-size: 0.9rem; }

        /* Lookback toggle */
        .lookback-toggle { display: flex; gap: 8px; margin-bottom: 20px; }
        .lookback-btn {
            padding: 6px 14px; border-radius: 6px; border: 1px solid var(--border);
            background: var(--surface-2); color: var(--text-muted); cursor: pointer;
            font-size: 0.8rem; font-family: inherit; text-decoration: none;
        }
        .lookback-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }

        /* Change cards */
        .change-card {
            display: flex; justify-content: space-between; align-items: center;
            padding: 12px 0; border-bottom: 1px solid var(--border);
        }
        .change-card:last-child { border-bottom: none; }
        .change-meta { display: flex; flex-direction: column; }
        .change-permit { font-weight: 500; font-size: 0.95rem; }
        .change-permit a { color: var(--text); text-decoration: none; }
        .change-permit a:hover { color: var(--accent); text-decoration: underline; }
        .change-detail { font-size: 0.8rem; color: var(--text-muted); }
        .status-badge {
            display: inline-block; padding: 2px 8px; border-radius: 4px;
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
        }
        .status-filed { background: rgba(79, 143, 247, 0.15); color: var(--accent); }
        .status-approved { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .status-issued { background: rgba(52, 211, 153, 0.2); color: var(--success); }
        .status-completed { background: rgba(52, 211, 153, 0.3); color: var(--success); }
        .status-expired, .status-cancelled { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .status-arrow { color: var(--text-muted); margin: 0 4px; }

        /* Health bars */
        .health-item {
            padding: 14px 0; border-bottom: 1px solid var(--border);
        }
        .health-item:last-child { border-bottom: none; }
        .health-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 6px; }
        .health-label { font-weight: 500; font-size: 0.9rem; }
        .health-label a { color: var(--text); text-decoration: none; }
        .health-label a:hover { color: var(--accent); text-decoration: underline; }
        .health-status {
            font-size: 0.75rem; font-weight: 600; text-transform: uppercase;
            padding: 2px 8px; border-radius: 4px;
        }
        .health-on_track { background: rgba(52, 211, 153, 0.15); color: var(--success); }
        .health-slower { background: rgba(251, 191, 36, 0.15); color: var(--warning); }
        .health-behind { background: rgba(248, 113, 113, 0.15); color: var(--error); }
        .health-at_risk { background: rgba(248, 113, 113, 0.25); color: var(--error); }
        .progress-track {
            height: 8px; background: var(--surface-2); border-radius: 4px;
            position: relative; overflow: visible; margin-top: 4px;
        }
        .progress-fill {
            height: 100%; border-radius: 4px; transition: width 0.3s;
        }
        .progress-fill.on_track { background: var(--success); }
        .progress-fill.slower { background: var(--warning); }
        .progress-fill.behind { background: var(--error); }
        .progress-fill.at_risk { background: var(--error); }
        .health-detail { font-size: 0.8rem; color: var(--text-muted); margin-top: 4px; }

        /* Inspection results */
        .insp-pass { color: var(--success); }
        .insp-fail { color: var(--error); }
        .insp-other { color: var(--text-muted); }

        /* Expiring */
        .expire-urgent { color: var(--error); font-weight: 600; }
        .expire-warning { color: var(--warning); }

        /* Onboarding empty state */
        .onboarding {
            text-align: center;
            padding: 48px 24px;
        }
        .onboarding h2 { color: var(--text); font-size: 1.2rem; margin-bottom: 12px; }
        .onboarding p { color: var(--text-muted); margin-bottom: 20px; max-width: 480px; margin-left: auto; margin-right: auto; }
        .onboarding .btn {
            display: inline-block;
            padding: 10px 24px;
            background: var(--accent);
            color: #fff;
            text-decoration: none;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.95rem;
        }
        .onboarding .btn:hover { background: var(--accent-hover); }

        /* Reviewed (dismiss) */
        .btn-dismiss {
            background: none; border: 1px solid var(--border); color: var(--text-muted);
            padding: 3px 10px; border-radius: 5px; cursor: pointer;
            font-size: 0.75rem; font-family: inherit; margin-left: 8px;
        }
        .btn-dismiss:hover { border-color: var(--success); color: var(--success); }
    </style>
</head>
<body>
    {% set active_page = 'brief' %}
    {% include 'fragments/nav.html' %}

    <main>
        <div class="container">
            <h1>Good Morning{% if user.display_name %}, {{ user.display_name }}{% endif %}</h1>
            <p class="subtitle">
                {% if brief.property_synopsis %}
                    Monitoring <strong>{{ brief.property_synopsis.address }}</strong>
                    {% if brief.property_synopsis.neighborhood %} &middot; {{ brief.property_synopsis.neighborhood }}{% endif %}
                    &middot;
                {% endif %}
                {{ brief.lookback_days }} day{{ 's' if brief.lookback_days > 1 else '' }} lookback
                {% if brief.last_refresh %}
                    &middot; Data as of {{ brief.last_refresh.last_success_date }}
                {% endif %}
            </p>
            {% if brief.last_refresh and brief.last_refresh.is_stale %}
            <div style="background:rgba(251,191,36,0.1);border:1px solid rgba(251,191,36,0.3);border-radius:8px;padding:10px 16px;margin-bottom:16px;font-size:0.85rem;color:var(--warning);">
                &#9888; Data may be incomplete &mdash; last refresh was {{ brief.last_refresh.hours_ago|int }} hours ago.
                {% if brief.last_refresh.was_catchup %}Some changes were recovered via backfill.{% endif %}
            </div>
            {% endif %}

            <!-- Lookback toggle (always visible at top) -->
            <div class="lookback-toggle">
                <a href="/brief?lookback=1" class="lookback-btn {{ 'active' if brief.lookback_days == 1 else '' }}">Today</a>
                <a href="/brief?lookback=7" class="lookback-btn {{ 'active' if brief.lookback_days == 7 else '' }}">Last 7 days</a>
                <a href="/brief?lookback=30" class="lookback-btn {{ 'active' if brief.lookback_days == 30 else '' }}">Last 30 days</a>
            </div>

            {% if brief.property_synopsis %}
            <!-- Property Synopsis -->
            <div class="section" style="margin-bottom:28px;">
                <h2>Your Property</h2>
                <div class="summary-row" style="margin-bottom:16px;">
                    <div class="summary-card">
                        <div class="summary-number">{{ brief.property_synopsis.total_permits }}</div>
                        <div class="summary-label">Total Permits</div>
                    </div>
                    <div class="summary-card {{ 'ok' if brief.property_synopsis.active_count > 0 else '' }}">
                        <div class="summary-number">{{ brief.property_synopsis.active_count }}</div>
                        <div class="summary-label">Active</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-number">{{ brief.property_synopsis.completed_count }}</div>
                        <div class="summary-label">Completed</div>
                    </div>
                </div>
                {% if brief.property_synopsis.latest_permit %}
                <div style="margin-bottom:12px;">
                    <span style="font-size:0.8rem;color:var(--text-muted);text-transform:uppercase;">Most Recent</span>
                    <div style="margin-top:4px;">
                        <a href="/?q={{ brief.property_synopsis.latest_permit.permit_number }}"
                           style="color:var(--accent);text-decoration:none;font-weight:500;">
                            {{ brief.property_synopsis.latest_permit.permit_number }}
                        </a>
                        &middot;
                        <span class="status-badge status-{{ brief.property_synopsis.latest_permit.status|lower }}">
                            {{ brief.property_synopsis.latest_permit.status }}
                        </span>
                        &middot; {{ brief.property_synopsis.latest_permit.type }}
                        {% if brief.property_synopsis.latest_permit.filed_date %}
                        &middot; Filed {{ brief.property_synopsis.latest_permit.filed_date }}
                        {% endif %}
                    </div>
                    {% if brief.property_synopsis.latest_permit.description %}
                    <div style="font-size:0.85rem;color:var(--text-muted);margin-top:2px;">
                        {{ brief.property_synopsis.latest_permit.description }}
                    </div>
                    {% endif %}
                </div>
                {% endif %}
                {% if brief.property_synopsis.top_types %}
                <div style="font-size:0.8rem;color:var(--text-muted);">
                    <span style="text-transform:uppercase;">Permit Types:</span>
                    {% for ptype, count in brief.property_synopsis.top_types %}
                        {{ ptype }} ({{ count }}){% if not loop.last %},{% endif %}
                    {% endfor %}
                </div>
                {% endif %}
                {% if brief.property_synopsis.block and brief.property_synopsis.lot %}
                <div style="font-size:0.75rem;color:var(--text-muted);margin-top:8px;">
                    Block {{ brief.property_synopsis.block }}, Lot {{ brief.property_synopsis.lot }}
                    {% if brief.property_synopsis.earliest_date and brief.property_synopsis.latest_date %}
                    &middot; Permit history: {{ brief.property_synopsis.earliest_date }} &ndash; {{ brief.property_synopsis.latest_date }}
                    {% endif %}
                </div>
                <div style="margin-top:12px;">
                    <a href="/report/{{ brief.property_synopsis.block }}/{{ brief.property_synopsis.lot }}"
                       style="display:inline-block;padding:8px 18px;background:var(--accent);color:#fff;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.85rem;">
                        View Property Report &rarr;
                    </a>
                </div>
                {% endif %}
            </div>
            {% endif %}

            {% if brief.summary.total_watches == 0 and not brief.property_synopsis %}
            <!-- Onboarding: no watches yet -->
            <div class="section onboarding">
                <h2>Your morning brief is ready to go</h2>
                <p>
                    Start watching permits, addresses, or neighborhoods and you'll see
                    status changes, inspection results, and health alerts right here every morning.
                </p>
                <a href="/" class="btn">Search permits to start watching</a>
            </div>
            {% elif brief.summary.total_watches > 0 or brief.property_synopsis %}

            <!-- Summary cards -->
            <div class="summary-row">
                <div class="summary-card">
                    <div class="summary-number">{{ brief.summary.total_watches }}</div>
                    <div class="summary-label">Watching</div>
                </div>
                <div class="summary-card {{ 'ok' if brief.summary.changes_count > 0 else '' }}">
                    <div class="summary-number">{{ brief.summary.changes_count }}</div>
                    <div class="summary-label">Changed</div>
                </div>
                <div class="summary-card {{ 'alert' if brief.summary.stale_critical > 0 or brief.summary.at_risk_count > 0 else ('warn' if brief.summary.stale_count > 0 or brief.summary.expiring_count > 0 else '') }}">
                    <div class="summary-number">{{ brief.summary.at_risk_count + brief.summary.stale_count + brief.summary.expiring_count }}</div>
                    <div class="summary-label">Needs Attention</div>
                </div>
                <div class="summary-card {{ 'warn' if brief.summary.inspections_count > 0 else '' }}">
                    <div class="summary-number">{{ brief.summary.inspections_count }}</div>
                    <div class="summary-label">Inspections</div>
                </div>
            </div>

            {% set all_empty = not brief.changes and not brief.health and not brief.inspections and not brief.new_filings and not brief.team_activity and not brief.expiring and not brief.stale and not brief.property_synopsis %}
            {% if all_empty %}
            <div style="background: rgba(79, 143, 247, 0.06); border: 1px solid rgba(79, 143, 247, 0.2); border-radius: 10px; padding: 24px; margin-bottom: 24px; text-align: center;">
                <div style="font-size: 1.5rem; margin-bottom: 8px;">&#x2705;</div>
                <div style="font-weight: 600; margin-bottom: 6px;">All quiet on your watched items</div>
                <div style="color: var(--text-muted); font-size: 0.9rem; max-width: 480px; margin: 0 auto;">
                    You're watching {{ brief.summary.total_watches }} item{{ 's' if brief.summary.total_watches != 1 else '' }},
                    but there's no permit activity to report
                    {% if brief.lookback_days == 1 %}today. Try <a href="/brief?lookback=7" style="color:var(--accent);">last 7 days</a> or <a href="/brief?lookback=30" style="color:var(--accent);">last 30 days</a> for a wider view.{% elif brief.lookback_days < 30 %}in the last {{ brief.lookback_days }} days. Try <a href="/brief?lookback=30" style="color:var(--accent);">last 30 days</a> for a wider view.{% else %}in the last 30 days.{% endif %}
                </div>
                <div style="margin-top: 16px;">
                    <a href="/" style="color: var(--accent); text-decoration: none; font-size: 0.9rem;">Search for permits to watch &rarr;</a>
                </div>
            </div>
            {% endif %}

            <!-- Action Items (from intelligence engine) -->
            {% if brief.action_items %}
            <div class="section" style="border-left: 3px solid var(--accent);">
                <h2 style="display: flex; align-items: center; gap: 8px;">
                    <span style="font-size: 1.2rem;">&#128161;</span> Action Items
                    <span style="font-size: 0.75rem; color: var(--text-muted); font-weight: 400;">
                        {{ brief.action_items | length }} recommendation{{ 's' if brief.action_items | length != 1 }}
                    </span>
                </h2>
                {% for item in brief.action_items %}
                <div class="change-card" style="border-left: 3px solid {{ 'var(--error)' if item.severity == 'critical' else 'var(--warning)' if item.severity == 'warning' else 'var(--accent)' }}; padding-left: 12px; margin-bottom: 8px;">
                    <div class="change-meta" style="flex: 1;">
                        <div class="change-permit">
                            {% if item.severity == 'critical' %}
                            <span style="color: var(--error); font-size: 0.8rem;">&#9888; Critical</span>
                            {% elif item.severity == 'warning' %}
                            <span style="color: var(--warning); font-size: 0.8rem;">&#9888; Warning</span>
                            {% else %}
                            <span style="color: var(--accent); font-size: 0.8rem;">&#128161; Tip</span>
                            {% endif %}
                            &mdash; {{ item.title }}
                        </div>
                        <div class="change-detail">{{ item.detail }}</div>
                        <div style="margin-top: 6px; font-size: 0.85rem;">
                            <strong style="color: var(--accent);">&#8594; {{ item.suggested_action }}</strong>
                            {% if item.savings_estimate %}
                            <span style="color: var(--text-muted); margin-left: 8px;">({{ item.savings_estimate }})</span>
                            {% endif %}
                        </div>
                    </div>
                </div>
                {% endfor %}
                <div style="margin-top: 12px; text-align: right;">
                    <a href="/portfolio?filter=action_needed" style="color: var(--accent); font-size: 0.85rem; text-decoration: none;">
                        View all in Portfolio &rarr;
                    </a>
                </div>
            </div>
            {% endif %}

            <!-- Section 1: What Changed -->
            <div class="section">
                <h2>What Changed</h2>
                {% if brief.changes %}
                {% for c in brief.changes %}
                <div class="change-card" id="change-{{ loop.index }}">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ c.permit_number }}" title="Look up permit details">{{ c.label or c.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ c.permit_number }}
                            {% if c.street_number %} &middot; {{ c.street_number }} {{ c.street_name }}{% endif %}
                            {% if c.neighborhood %} &middot; {{ c.neighborhood }}{% endif %}
                            {% if c.permit_type %} &middot; {{ c.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div style="display:flex;align-items:center;">
                        {% if c.old_status %}
                        <span class="status-badge status-{{ c.old_status|lower }}">{{ c.old_status }}</span>
                        <span class="status-arrow">&rarr;</span>
                        {% endif %}
                        <span class="status-badge status-{{ c.new_status|lower }}">{{ c.new_status }}</span>
                        <button class="btn-dismiss" onclick="this.closest('.change-card').style.opacity='0.3';this.remove();" title="Mark reviewed">&#10003;</button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">
                    No status changes on your watched items in this period.
                    {% if brief.lookback_days == 1 %}Try <a href="/brief?lookback=7" style="color:var(--accent);">last 7 days</a> for a wider view.{% endif %}
                </p>
                {% endif %}
            </div>

            <!-- Section 2: Permit Health -->
            <div class="section">
                <h2>Permit Health</h2>
                {% if brief.health %}
                {% for h in brief.health %}
                <div class="health-item">
                    <div class="health-header">
                        <span class="health-label">
                            <a href="/?q={{ h.permit_number }}" title="Look up permit details">{{ h.label or h.permit_number }}</a>
                        </span>
                        <span class="health-status health-{{ h.status }}">{{ h.status|replace('_', ' ') }}</span>
                    </div>
                    <div class="progress-track">
                        <div class="progress-fill {{ h.status }}"
                             style="width: {{ [h.pct_of_typical, 100] | min }}%"></div>
                    </div>
                    <div class="health-detail">
                        {{ h.elapsed_days }} days elapsed &middot;
                        typical: {{ h.p50 }} days &middot;
                        {{ h.pct_of_typical }}% of typical
                        ({{ h.sample_size }} similar permits)
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">
                    No active watched permits to track. Watch a specific permit number to see health tracking here.
                </p>
                {% endif %}
            </div>

            <!-- Section 3: Inspection Results -->
            <div class="section">
                <h2>Inspection Results</h2>
                {% if brief.inspections %}
                {% for insp in brief.inspections %}
                <div class="change-card" id="insp-{{ loop.index }}">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ insp.permit_number }}" title="Look up permit details">{{ insp.label or insp.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ insp.description or 'Inspection' }}
                            {% if insp.inspector %} &middot; {{ insp.inspector }}{% endif %}
                            &middot; {{ insp.date }}
                        </span>
                    </div>
                    <div style="display:flex;align-items:center;">
                        <span class="status-badge {% if insp.is_pass %}status-approved{% elif insp.is_fail %}status-expired{% else %}{% endif %}">
                            {{ insp.result or 'Pending' }}
                        </span>
                        <button class="btn-dismiss" onclick="this.closest('.change-card').style.opacity='0.3';this.remove();" title="Mark reviewed">&#10003;</button>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">
                    No recent inspections on your watched permits.
                    {% if brief.lookback_days == 1 %}Try <a href="/brief?lookback=7" style="color:var(--accent);">last 7 days</a>.{% endif %}
                </p>
                {% endif %}
            </div>

            <!-- Section 4: New Filings -->
            <div class="section">
                <h2>New Filings at Watched Locations</h2>
                {% if brief.new_filings %}
                {% for f in brief.new_filings %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ f.permit_number }}" title="Look up permit details">{{ f.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ f.street_number }} {{ f.street_name }}
                            {% if f.neighborhood %} &middot; {{ f.neighborhood }}{% endif %}
                            {% if f.permit_type %} &middot; {{ f.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge status-filed">new</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No new permits filed at your watched addresses or parcels.</p>
                {% endif %}
            </div>

            <!-- Section 5: Team Activity -->
            <div class="section">
                <h2>Team Activity</h2>
                {% if brief.team_activity %}
                {% for t in brief.team_activity %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">{{ t.entity_name }} ({{ t.role }})</span>
                        <span class="change-detail">
                            <a href="/?q={{ t.permit_number }}" style="color:var(--text-muted);text-decoration:none;">{{ t.permit_number }}</a> &middot;
                            {{ t.street_number }} {{ t.street_name }}
                            {% if t.neighborhood %} &middot; {{ t.neighborhood }}{% endif %}
                            {% if t.permit_type %} &middot; {{ t.permit_type }}{% endif %}
                        </span>
                    </div>
                    <div>
                        <span class="status-badge status-{{ t.status|lower }}">{{ t.status }}</span>
                    </div>
                </div>
                {% endfor %}
                {% else %}
                <p class="section-empty">No new activity from your watched contractors, architects, or expediters.</p>
                {% endif %}
            </div>

            <!-- Section: Permits Needing Attention -->
            {% if brief.stale or brief.expiring %}
            <div class="section" style="border-left: 3px solid var(--error);">
                <h2>Permits Needing Attention</h2>

                {% if brief.stale %}
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 16px;">
                    Stale permits — potential re-filing costs: ${{ "{:,.0f}".format(brief.stale | map(attribute='refiling_estimate') | sum) }}
                </p>
                {% for item in brief.stale %}
                <div class="change-card" style="border-left: 3px solid {{ 'var(--error)' if item.severity == 'critical' else 'var(--warning)' }}; padding-left: 12px;">
                    <div class="change-meta">
                        <div class="change-permit">
                            <span style="font-size: 0.75rem; {% if item.severity == 'critical' %}color: var(--error);{% else %}color: var(--warning);{% endif %}">
                                &#9888;
                                {{ item.alert_type | replace('_', ' ') | title }}
                            </span>
                            &mdash;
                            <a href="/report/{{ item.block }}/{{ item.lot }}">{{ item.address }}</a>
                        </div>
                        <div class="change-detail">
                            {{ item.permit_number }} &middot; {{ item.permit_type }} &middot; {{ item.days_stale }} days
                        </div>
                        <div style="margin-top: 6px; font-size: 0.85rem; color: var(--text);">
                            {{ item.suggested_action }}
                        </div>
                    </div>
                    <span class="status-badge status-{{ item.status }}">{{ item.status }}</span>
                </div>
                {% endfor %}
                {% endif %}

                {% if brief.expiring %}
                {% if brief.stale %}<div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--border);"></div>{% endif %}
                <p style="color: var(--text-muted); font-size: 0.85rem; margin-bottom: 12px;">Approaching expiration</p>
                {% for e in brief.expiring %}
                <div class="change-card">
                    <div class="change-meta">
                        <span class="change-permit">
                            <a href="/?q={{ e.permit_number }}" title="Look up permit details">{{ e.label or e.permit_number }}</a>
                        </span>
                        <span class="change-detail">
                            {{ e.street_number }} {{ e.street_name }}
                            {% if e.neighborhood %} &middot; {{ e.neighborhood }}{% endif %}
                            &middot; Issued: {{ e.issued_date }}
                        </span>
                    </div>
                    <div>
                        {% if e.is_expired %}
                        <span class="expire-urgent">EXPIRED ({{ -e.expires_in }} days ago)</span>
                        {% else %}
                        <span class="expire-warning">Expires in {{ e.expires_in }} days</span>
                        {% endif %}
                    </div>
                </div>
                {% endfor %}
                {% endif %}
            </div>
            {% endif %}

            <!-- Email preferences hint -->
            <div style="text-align:center;margin-top:16px;font-size:0.8rem;">
                <a href="/portfolio" style="color:var(--text-muted);text-decoration:none;">Portfolio</a>
                <span style="color:var(--border);margin:0 8px;">&middot;</span>
                <a href="/account" style="color:var(--text-muted);text-decoration:none;">
                    Manage email preferences
                </a>
            </div>

            {% endif %}{# end of total_watches > 0 or property_synopsis #}
        </div>
    </main>
    {% include 'fragments/feedback_widget.html' %}
</body>
</html>
