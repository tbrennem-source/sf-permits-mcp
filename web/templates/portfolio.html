<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>Portfolio — sfpermits.ai</title>
    {% include "fragments/head_obsidian.html" %}
    <script nonce="{{ csp_nonce }}" src="/static/htmx.min.js"></script>
    <style nonce="{{ csp_nonce }}">
        /* ── Portfolio layout ────────────────────────────────────────── */
        .portfolio-main {
            padding: var(--space-8) 0 var(--space-16);
            display: flex;
            flex-direction: column;
            gap: var(--space-6);
        }

        /* Summary stats */
        .summary-row {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: var(--space-4);
        }
        @media (max-width: 640px) {
            .summary-row { grid-template-columns: repeat(2, 1fr); gap: var(--space-3); }
        }
        @media (max-width: 360px) {
            .summary-row { grid-template-columns: 1fr 1fr; }
        }

        /* Filter bar */
        .filter-bar {
            display: flex;
            gap: var(--space-2);
            flex-wrap: wrap;
            align-items: center;
        }
        .filter-chip {
            font-family: var(--mono);
            font-size: var(--text-xs);
            font-weight: 400;
            color: var(--text-secondary);
            background: var(--bg-glass);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: 9999px;
            padding: 4px 12px;
            cursor: pointer;
            text-decoration: none;
            transition: border-color 0.2s, color 0.2s;
            white-space: nowrap;
        }
        .filter-chip:hover {
            color: var(--text-primary);
            border-color: rgba(255,255,255,0.14);
        }
        .filter-chip.active {
            color: var(--signal-cyan);
            border-color: rgba(34, 211, 238, 0.3);
            background: rgba(34, 211, 238, 0.06);
        }
        .sort-select {
            font-family: var(--mono);
            font-size: var(--text-xs);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            border: 1px solid rgba(255,255,255,0.06);
            padding: 5px 10px;
            border-radius: 6px;
            margin-left: auto;
            outline: none;
            cursor: pointer;
        }

        /* Property grid */
        .property-grid {
            display: grid;
            gap: var(--space-4);
            grid-template-columns: 1fr;
        }
        @media (min-width: 700px) {
            .property-grid { grid-template-columns: 1fr 1fr; }
        }

        /* Property card */
        .property-card {
            background: var(--bg-surface);
            border: 1px solid rgba(255,255,255,0.06);
            border-radius: var(--card-radius, 12px);
            padding: var(--space-6);
            position: relative;
            cursor: pointer;
            transition: border-color 0.2s;
        }
        .property-card:hover {
            border-color: rgba(255,255,255,0.12);
        }
        /* Left-edge health indicator using status-dot color */
        .property-card.health-at_risk  { border-left: 3px solid var(--signal-red); }
        .property-card.health-behind   { border-left: 3px solid var(--signal-amber); }
        .property-card.health-slower   { border-left: 3px solid var(--signal-amber); }
        .property-card.health-on_track { border-left: 3px solid var(--signal-green); }

        /* Card header row */
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: var(--space-2);
        }
        .card-address {
            font-family: var(--mono);
            font-size: var(--text-sm);
            font-weight: 400;
            color: var(--text-primary);
        }
        .card-address a {
            color: var(--text-primary);
            text-decoration: none;
            transition: color 0.2s;
        }
        .card-address a:hover { color: var(--signal-cyan); }

        /* Health indicator */
        .health-indicator {
            display: flex;
            align-items: center;
            gap: var(--space-1);
            flex-shrink: 0;
        }
        .health-dot {
            width: 6px;
            height: 6px;
            border-radius: 9999px;
            display: inline-block;
            flex-shrink: 0;
            margin-top: 3px;
        }
        .health-dot.on_track  { background: var(--signal-green); }
        .health-dot.slower    { background: var(--signal-amber); }
        .health-dot.behind    { background: var(--signal-amber); }
        .health-dot.at_risk   { background: var(--signal-red); }
        .health-dot.complete  { background: var(--text-tertiary); }

        .health-text {
            font-family: var(--mono);
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.06em;
            font-weight: 400;
        }
        .health-text.at_risk  { color: var(--signal-red); }
        .health-text.behind   { color: var(--signal-amber); }
        .health-text.slower   { color: var(--signal-amber); }
        .health-text.on_track { color: var(--signal-green); }
        .health-text.complete { color: var(--text-tertiary); }

        /* Card metadata */
        .card-health-reason {
            font-family: var(--sans);
            font-size: var(--text-xs);
            font-style: italic;
            margin-bottom: var(--space-2);
        }
        .health-at_risk .card-health-reason  { color: var(--signal-red); }
        .health-behind  .card-health-reason  { color: var(--signal-amber); }
        .health-slower  .card-health-reason  { color: var(--signal-amber); }

        .card-recency {
            font-family: var(--mono);
            font-size: var(--text-xs);
            margin-bottom: var(--space-1);
        }
        .card-recency.fresh { color: var(--signal-green); }
        .card-recency.stale { color: var(--text-secondary); }

        .card-neighborhood {
            font-family: var(--sans);
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        .card-stats {
            display: flex;
            gap: var(--space-4);
            font-family: var(--mono);
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: var(--space-2);
        }

        /* Tags */
        .tag-pill {
            display: inline-block;
            font-family: var(--mono);
            font-size: var(--text-xs);
            background: rgba(34, 211, 238, 0.06);
            color: var(--signal-cyan);
            border: 1px solid rgba(34, 211, 238, 0.2);
            padding: 1px 7px;
            border-radius: 3px;
            margin-right: var(--space-1);
        }

        /* Expanded permit list */
        .permit-list {
            margin-top: var(--space-4);
            border-top: 1px solid rgba(255,255,255,0.06);
            padding-top: var(--space-4);
            display: none;
        }
        .property-card.expanded .permit-list { display: block; }

        /* Permit rows in expanded view */
        .permit-row {
            padding: var(--space-2) 0;
            border-bottom: 1px solid rgba(255,255,255,0.04);
            font-family: var(--mono);
            font-size: var(--text-xs);
        }
        .permit-row:last-child { border-bottom: none; }

        .permit-status {
            display: inline-block;
            padding: 1px 7px;
            border-radius: 3px;
            font-size: 10px;
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.04em;
        }
        .permit-status.filed    { background: rgba(34, 211, 238, 0.1);  color: var(--signal-cyan); }
        .permit-status.issued   { background: rgba(52, 211, 153, 0.1);  color: var(--signal-green); }
        .permit-status.complete { background: rgba(52, 211, 153, 0.15); color: var(--signal-green); }
        .permit-status.triage   { background: rgba(251, 191, 36, 0.1);  color: var(--signal-amber); }

        /* Enforcement row */
        .enforce-row {
            display: flex;
            gap: var(--space-3);
            align-items: center;
            margin-bottom: var(--space-3);
            font-family: var(--mono);
            font-size: var(--text-xs);
            flex-wrap: wrap;
        }
        .enforce-label {
            color: var(--text-secondary);
            font-weight: 400;
            text-transform: uppercase;
            letter-spacing: 0.06em;
        }
        .enforce-badge {
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 400;
        }
        .enforce-badge.clear   { background: rgba(52,211,153,0.1);  color: var(--signal-green); }
        .enforce-badge.alert   { background: rgba(248,113,113,0.1);  color: var(--signal-red); }
        .enforce-badge.unknown { background: rgba(255,255,255,0.04); color: var(--text-secondary); }

        /* Routing progress */
        .routing-section { margin-bottom: var(--space-3); }
        .routing-label {
            font-family: var(--mono);
            font-size: var(--text-xs);
            color: var(--text-secondary);
            margin-bottom: var(--space-1);
        }
        .routing-bar-wrap {
            background: var(--bg-elevated);
            border-radius: 3px;
            height: 4px;
            overflow: hidden;
            margin-bottom: var(--space-1);
        }
        .routing-bar-fill {
            height: 100%;
            border-radius: 3px;
            transition: width 0.4s;
        }
        .routing-fill-ok  { background: var(--signal-green); }
        .routing-fill-mid { background: var(--signal-amber); }
        .routing-fill-low { background: var(--signal-cyan); }
        .routing-stations {
            font-family: var(--mono);
            font-size: var(--text-xs);
            color: var(--text-secondary);
        }
        .routing-alert {
            font-family: var(--mono);
            font-size: var(--text-xs);
            margin-top: var(--space-1);
        }
        .routing-alert.stalled { color: var(--signal-red); }
        .routing-alert.held    { color: var(--signal-amber); }

        /* Empty state */
        .portfolio-empty {
            text-align: center;
            padding: var(--space-16) var(--space-6);
        }
        .portfolio-empty h2 {
            font-family: var(--sans);
            font-size: var(--text-lg);
            font-weight: 400;
            color: var(--text-primary);
            margin-bottom: var(--space-2);
        }
        .portfolio-empty p {
            font-family: var(--sans);
            color: var(--text-secondary);
            font-size: var(--text-sm);
            max-width: 420px;
            margin: 0 auto var(--space-6);
        }
        .portfolio-empty-actions {
            display: flex;
            gap: var(--space-3);
            justify-content: center;
            flex-wrap: wrap;
        }

        /* Card expand animation */
        @keyframes card-expand-pulse { from { opacity: 1; } to { opacity: 0.5; } }
        .property-card.expanding {
            animation: card-expand-pulse 0.35s ease-in-out 2 alternate;
        }

        /* Timeline loading */
        .timeline-loading {
            font-family: var(--mono);
            font-size: var(--text-xs);
            color: var(--text-secondary);
            padding: var(--space-2) 0;
            font-style: italic;
        }

        @media (max-width: 500px) {
            .filter-bar { flex-direction: column; align-items: stretch; }
            .filter-chip { text-align: center; }
            .sort-select { margin-left: 0; width: 100%; }
        }
    </style>
</head>
<body class="obsidian">
    {% set active_page = 'portfolio' %}
    {% include 'fragments/nav.html' %}
    <main>
        <div class="obs-container portfolio-main">
            <div>
                <h1 style="font-family: var(--sans); font-size: var(--text-xl); font-weight: 300; color: var(--text-primary); margin-bottom: var(--space-1);">Portfolio</h1>
                <p style="font-family: var(--mono); font-size: var(--text-xs); color: var(--text-secondary);">{{ summary.total_properties }} properties &middot; {{ summary.total_active_permits }} active permits</p>
            </div>

            {% if properties %}
            <!-- Summary stats row -->
            <div class="summary-row">
                <div class="glass-card" style="padding: var(--space-4) var(--space-6); text-align: center;">
                    <div class="stat-number" style="font-size: var(--text-xl);">{{ summary.total_properties }}</div>
                    <div class="stat-label">Properties</div>
                </div>
                <div class="glass-card" style="padding: var(--space-4) var(--space-6); text-align: center;">
                    <div class="stat-number" style="font-size: var(--text-xl); color: {% if summary.action_needed > 0 %}var(--signal-red){% else %}var(--signal-green){% endif %};">{{ summary.action_needed }}</div>
                    <div class="stat-label">Action Needed</div>
                </div>
                <div class="glass-card" style="padding: var(--space-4) var(--space-6); text-align: center;">
                    <div class="stat-number" style="font-size: var(--text-xl); color: {% if summary.in_review > 0 %}var(--signal-amber){% else %}var(--text-primary){% endif %};">{{ summary.in_review }}</div>
                    <div class="stat-label">In Review</div>
                </div>
                <div class="glass-card" style="padding: var(--space-4) var(--space-6); text-align: center;">
                    <div class="stat-number" style="font-size: var(--text-xl);">${{ "{:,.0f}".format(summary.total_value / 1000000) }}M</div>
                    <div class="stat-label">Portfolio Value</div>
                </div>
            </div>

            <!-- Filter / sort bar -->
            <div class="filter-bar">
                <a href="/portfolio" class="filter-chip {{ 'active' if not filter_by or filter_by == 'all' }}">All</a>
                <a href="/portfolio?filter=action_needed&sort={{ sort_by }}" class="filter-chip {{ 'active' if filter_by == 'action_needed' }}">Action Needed</a>
                <a href="/portfolio?filter=in_review&sort={{ sort_by }}" class="filter-chip {{ 'active' if filter_by == 'in_review' }}">In Review</a>
                <a href="/portfolio?filter=active&sort={{ sort_by }}" class="filter-chip {{ 'active' if filter_by == 'active' }}">Active</a>
                <select class="sort-select" onchange="window.location.href='/portfolio?filter={{ filter_by or 'all' }}&sort='+this.value">
                    <option value="recent" {{ 'selected' if sort_by == 'recent' or not sort_by }}>Recent Activity</option>
                    <option value="cost_desc" {{ 'selected' if sort_by == 'cost_desc' }}>Highest Cost</option>
                    <option value="stale" {{ 'selected' if sort_by == 'stale' }}>Most Stale</option>
                    <option value="health" {{ 'selected' if sort_by == 'health' }}>Worst Health</option>
                </select>
            </div>

            <!-- Property Grid -->
            <div class="property-grid">
                {% for prop in properties %}
                <div class="property-card health-{{ prop.worst_health }}" onclick="toggleCard(this)">
                    <div class="card-header">
                        <div class="card-address">
                            <a href="/report/{{ prop.block }}/{{ prop.lot }}" onclick="event.stopPropagation()">{{ prop.address }}</a>
                        </div>
                        <span class="health-indicator">
                            <span class="health-dot {{ prop.worst_health }}"></span>
                            <span class="health-text {{ prop.worst_health }}">{{ prop.worst_health | replace('_', ' ') | title }}</span>
                        </span>
                    </div>
                    {% if prop.health_reason and prop.worst_health != 'on_track' %}
                    <div class="card-health-reason">{{ prop.health_reason }}</div>
                    {% endif %}
                    {% if prop.days_since_activity is not none %}
                    <div class="card-recency {% if prop.days_since_activity <= 7 %}fresh{% else %}stale{% endif %}">
                        {% if prop.days_since_activity == 0 %}Activity today
                        {% elif prop.days_since_activity == 1 %}Activity yesterday
                        {% elif prop.days_since_activity <= 7 %}Activity {{ prop.days_since_activity }}d ago
                        {% else %}Last activity {{ prop.days_since_activity }}d ago
                        {% endif %}
                    </div>
                    {% endif %}
                    {% if prop.neighborhood %}
                    <div class="card-neighborhood">{{ prop.neighborhood }}</div>
                    {% endif %}
                    <div class="card-stats">
                        <span>{{ prop.active_count }} active</span>
                        <span>{{ prop.permits | length }} total</span>
                        {% if prop.total_cost %}
                        <span>${{ "{:,.0f}".format(prop.total_cost) }}</span>
                        {% endif %}
                        {% if prop.latest_activity %}
                        <span>Last: {{ prop.latest_activity }}</span>
                        {% endif %}
                    </div>
                    {% if prop.tags %}
                    <div style="margin-bottom: var(--space-1);">
                        {% for tag in prop.tags.split(',') if tag.strip() %}
                        <span class="tag-pill">{{ tag.strip() }}</span>
                        {% endfor %}
                    </div>
                    {% endif %}
                    {% if prop.last_inspection %}
                    <div style="font-family: var(--mono); font-size: var(--text-xs); color: var(--text-secondary);">
                        Last inspection: {{ prop.last_inspection.type }} &mdash;
                        <span style="color: {{ 'var(--signal-green)' if prop.last_inspection.result == 'PASSED' else 'var(--signal-red)' if prop.last_inspection.result == 'FAILED' else 'var(--text-secondary)' }}">
                            {{ prop.last_inspection.result or 'Pending' }}
                        </span>
                        ({{ prop.last_inspection.date }})
                    </div>
                    {% endif %}

                    <!-- Expanded permit list -->
                    <div class="permit-list">

                        <!-- Enforcement summary -->
                        {% if prop.open_violations is not none or prop.open_complaints is not none %}
                        <div class="enforce-row">
                            <span class="enforce-label">Enforcement</span>
                            {% set viol = prop.open_violations %}
                            {% set comp = prop.open_complaints %}
                            {% if (viol is not none and viol > 0) or (comp is not none and comp > 0) %}
                                {% if viol is not none and viol > 0 %}
                                <span class="enforce-badge alert">{{ viol }} violation{{ 's' if viol != 1 }}</span>
                                {% endif %}
                                {% if comp is not none and comp > 0 %}
                                <span class="enforce-badge alert">{{ comp }} complaint{{ 's' if comp != 1 }}</span>
                                {% endif %}
                            {% elif viol == 0 and comp == 0 %}
                                <span class="enforce-badge clear">No open enforcement</span>
                            {% else %}
                                <span class="enforce-badge unknown">Unknown</span>
                            {% endif %}
                        </div>
                        {% endif %}

                        <!-- Routing progress (plan check) -->
                        {% if prop.routing %}
                        {% set r = prop.routing %}
                        <div class="routing-section">
                            <div class="routing-label">Plan Check &middot; {{ r.permit_number }}</div>
                            <div class="routing-bar-wrap">
                                <div class="routing-bar-fill {% if r.completion_pct >= 75 %}routing-fill-ok{% elif r.completion_pct >= 40 %}routing-fill-mid{% else %}routing-fill-low{% endif %}"
                                     style="width: {{ r.completion_pct }}%;"></div>
                            </div>
                            <div class="routing-stations">
                                {{ r.completed_stations }}/{{ r.total_stations }} stations ({{ r.completion_pct }}%)
                                {% if r.pending_station_names %}
                                 &middot; Waiting: {{ r.pending_station_names | join(', ') }}
                                {% endif %}
                            </div>
                            {% if r.stalled_stations %}
                            <div class="routing-alert stalled">Stalled &gt;30d: {{ r.stalled_stations | join(', ') }}</div>
                            {% endif %}
                            {% if r.held_stations %}
                            <div class="routing-alert held">On hold: {{ r.held_stations | join(', ') }}</div>
                            {% endif %}
                        </div>
                        {% endif %}

                        {% for pm in prop.permits %}
                        <div class="permit-row">
                            <span class="permit-status {{ pm.status }}">{{ pm.status }}</span>
                            <strong style="color: var(--text-primary);">{{ pm.permit_number }}</strong> &mdash; <span style="color: var(--text-secondary);">{{ pm.permit_type }}</span>
                            {% if pm.cost %}<span style="color: var(--text-secondary);"> &middot; ${{ "{:,.0f}".format(pm.cost) }}</span>{% endif %}
                            <div style="font-family: var(--sans); font-size: var(--text-xs); color: var(--text-secondary); margin-top: var(--space-1);">{{ pm.description }}</div>
                        </div>
                        {% endfor %}

                        <!-- Inspection timeline (lazy-loaded when card is expanded) -->
                        <div id="timeline-{{ prop.block }}-{{ prop.lot }}"
                             hx-get="/portfolio/timeline/{{ prop.block }}/{{ prop.lot }}"
                             hx-trigger="revealed"
                             hx-swap="innerHTML">
                            <div class="timeline-loading">Loading inspection history...</div>
                        </div>
                    </div>
                </div>
                {% endfor %}
            </div>

            <!-- Load more (if portfolio has many properties) -->
            {% if properties | length >= 20 %}
            <div class="load-more" style="display: flex; flex-direction: column; align-items: center; gap: var(--space-3); padding: var(--space-6) 0;">
                <span style="font-family: var(--mono); font-size: var(--text-xs); color: var(--text-secondary);">Showing {{ properties | length }} properties</span>
                <a href="/portfolio?filter={{ filter_by or 'all' }}&sort={{ sort_by or 'recent' }}&all=1" class="ghost-cta" style="font-family: var(--mono); font-size: var(--text-sm); color: var(--text-secondary); text-decoration: none; border-bottom: 1px solid transparent; transition: color 0.3s, border-color 0.3s;">Show all &rarr;</a>
            </div>
            {% endif %}

            {% else %}
            <!-- Empty state -->
            <div class="glass-card portfolio-empty">
                <h2>Your portfolio is empty</h2>
                <p>Start watching properties to track permit activity, health indicators, inspection timelines, and smart alerts &mdash; all in one place.</p>
                <div class="portfolio-empty-actions">
                    <a href="/search" class="obsidian-btn obsidian-btn-primary">Search for a property &rarr;</a>
                    <a href="/account" class="obsidian-btn obsidian-btn-outline">Import by name &rarr;</a>
                </div>
            </div>
            {% endif %}
        </div>
    </main>
    <script nonce="{{ csp_nonce }}">
    function toggleCard(card) {
        var isExpanding = !card.classList.contains('expanded');
        card.classList.toggle('expanded');
        if (isExpanding) {
            card.classList.add('expanding');
            setTimeout(function() { card.classList.remove('expanding'); }, 750);
            htmx.process(card);
        }
    }
    </script>
</body>
</html>
