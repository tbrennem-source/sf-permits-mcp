<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>My Account â€” sfpermits.ai</title>
    {% include "fragments/head_obsidian.html" %}
    <script nonce="{{ csp_nonce }}" src="/static/htmx.min.js"></script>
    <style nonce="{{ csp_nonce }}">
        /* Account page supplemental styles */
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(255,255,255, 0.06);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-secondary); }
        .watch-list { list-style: none; }
        .watch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid rgba(255,255,255, 0.06);
        }
        .watch-item:last-child { border-bottom: none; }
        .watch-meta {
            display: flex;
            flex-direction: column;
        }
        .watch-label { font-weight: 500; }
        .watch-type {
            font-size: 0.8rem;
            color: var(--text-secondary);
            text-transform: uppercase;
        }
        .btn-unwatch {
            background: none;
            border: 1px solid rgba(255,255,255, 0.06);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-unwatch:hover { color: var(--signal-red); border-color: var(--signal-red); }
        .btn-edit {
            background: none;
            border: 1px solid rgba(255,255,255, 0.06);
            color: var(--text-secondary);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-edit:hover { color: var(--signal-cyan); border-color: var(--signal-cyan); }
        .watch-search {
            width: 100%;
            margin-bottom: var(--space-4);
        }
        .watch-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
        .watch-edit-input {
            padding: 4px 8px;
            background: var(--bg-elevated);
            border: 1px solid var(--signal-cyan);
            border-radius: 4px;
            color: var(--text-primary);
            font-size: 0.85rem;
            width: 200px;
        }
        .watch-add-form {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: var(--space-4);
            padding-top: var(--space-4);
            border-top: 1px solid rgba(255,255,255, 0.06);
        }
        .watch-item.hidden { display: none; }
        .tag-pill {
            display: inline-block;
            background: rgba(34, 211, 238, 0.15);
            color: var(--signal-cyan);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-right: 4px;
        }
        .tag-editor { margin-top: 4px; }
        .empty { color: var(--text-secondary); font-style: italic; }
        .impersonate-banner {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid var(--signal-amber);
            color: var(--signal-amber);
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
        }
        .impersonate-banner form { display: inline; }
        .impersonate-banner button {
            background: none;
            border: 1px solid var(--signal-amber);
            color: var(--signal-amber);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        .admin-section {
            margin-top: var(--space-8);
        }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { display: inline; }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-completed { background: #1b5e20; color: #a5d6a7; }
        .status-processing { background: #0d47a1; color: #90caf9; }
        .status-pending { background: #4a4a00; color: #fff9c4; }
        .status-failed { background: #b71c1c; color: #ef9a9a; }
        .status-stale { background: #e65100; color: #ffcc80; }

        /* Tab bar */
        .tab-bar { display: flex; gap: 6px; margin-bottom: var(--space-6); flex-wrap: wrap; }
        .tab-btn {
            padding: 7px 16px;
            border-radius: 6px;
            font-size: var(--text-sm);
            border: 1px solid rgba(255,255,255, 0.06);
            background: var(--bg-elevated);
            color: var(--text-secondary);
            cursor: pointer;
            font-family: inherit;
            text-decoration: none;
            transition: all 0.15s;
        }
        .tab-btn:hover { border-color: var(--text-secondary); color: var(--text-primary); }
        .tab-btn.active { background: var(--signal-cyan); color: #0B0F19; border-color: var(--signal-cyan); font-weight: 600; }
        .tab-btn.loading {
            color: var(--signal-cyan) !important;
            background: var(--bg-elevated) !important;
            border-color: var(--signal-cyan) !important;
            animation: tab-pulse 0.5s ease-in-out infinite alternate;
        }
        @keyframes tab-pulse { from { border-color: rgba(34,211,238,0.3); } to { border-color: rgba(34,211,238,1); } }
        #tab-content { min-height: 200px; }
        .tab-loading { text-align: center; padding: 60px 0; color: var(--text-secondary); font-size: var(--text-sm); }
        .tab-loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid rgba(255,255,255, 0.06); border-top-color: var(--signal-cyan); border-radius: 50%; animation: spin 0.7s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Tab panel visibility */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }

        /* Page layout */
        main { padding: var(--space-10) 0 var(--space-16); }
        .account-header { margin-bottom: var(--space-8); }
        .account-header h1 {
            font-family: var(--font-display);
            font-size: var(--text-2xl);
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: var(--space-1);
        }
        .account-header .subtitle { color: var(--text-secondary); }

        /* .card = glass-card alias for fragments using old class name */
        .card {
            background: var(--bg-surface);
            border: 1px solid rgba(255,255,255, 0.06);
            border-radius: var(--card-radius);
            box-shadow: var(--card-shadow);
            backdrop-filter: blur(8px);
            padding: var(--space-6);
            margin-bottom: var(--space-6);
        }
        .card h2, .glass-card h2 {
            font-family: var(--font-display);
            font-size: var(--text-lg);
            font-weight: 600;
            margin-bottom: var(--space-4);
            color: var(--signal-cyan);
        }
    </style>
</head>
<body class="obsidian" hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    {% if session.get('impersonating') %}
    <div class="impersonate-banner">
        Viewing as {{ session.impersonating }}
        <form method="POST" action="/auth/stop-impersonate">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit">Stop impersonating</button>
        </form>
    </div>
    {% endif %}

    {% set active_page = 'account' %}
    {% include 'fragments/nav.html' %}

    <main>
        <div class="obs-container">
            <div class="account-header">
                <h1>My Account</h1>
                <p class="subtitle">{{ user.email }}</p>
            </div>

            {% if user.is_admin %}
            <!-- Admin users: tab bar with visual separator between Settings and Admin -->
            <div class="tab-bar tab-bar-divided" id="tab-bar">
                <button class="tab-btn active" data-tab="settings"
                        hx-get="/account/fragment/settings"
                        hx-target="#tab-content-settings"
                        hx-swap="innerHTML"
                        onclick="switchTab('settings')">Settings</button>
                <span class="tab-divider"></span>
                <button class="tab-btn" data-tab="admin"
                        hx-get="/account/fragment/admin"
                        hx-target="#tab-content-admin"
                        hx-swap="innerHTML"
                        onclick="switchTab('admin')">Admin<span class="tab-admin-badge">Admin</span></button>
            </div>
            <!-- Settings tab: pre-rendered server-side -->
            <div id="tab-content-settings" class="tab-panel active">
                {% include 'fragments/account_settings.html' %}
            </div>
            <!-- Admin tab: pre-rendered server-side -->
            <div id="tab-content-admin" class="tab-panel">
                {% include 'fragments/account_admin.html' %}
            </div>
            {% else %}
            <!-- Non-admin users: settings content rendered directly (no tab bar needed) -->
            {% include 'fragments/account_settings.html' %}
            {% endif %}
        </div>
    </main>

    {% include 'fragments/feedback_widget.html' %}

    {% if user.is_admin %}
    <script nonce="{{ csp_nonce }}">
    (function() {
        var activeTab = 'settings';

        // Read hash on load to restore tab state
        var hash = location.hash.replace('#', '');
        if (hash === 'settings' || hash === 'admin') {
            activeTab = hash;
        }

        function switchTab(tabName) {
            // Update button states
            document.querySelectorAll('.tab-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            // Update panel visibility
            document.querySelectorAll('.tab-panel').forEach(function(panel) {
                panel.classList.remove('active');
            });
            var panel = document.getElementById('tab-content-' + tabName);
            if (panel) panel.classList.add('active');
            // Persist to URL hash
            history.replaceState(null, '', '#' + tabName);
            activeTab = tabName;
        }

        // Make switchTab globally accessible (called from onclick)
        window.switchTab = switchTab;

        // Restore active tab from hash on page load
        if (activeTab !== 'settings') {
            switchTab(activeTab);
        }

        // After HTMX swaps fragment content, keep the panel visible
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            var d = evt.detail || {};
            var trigger = d.elt || (d.requestConfig && d.requestConfig.elt) || null;
            if (trigger && trigger.dataset && trigger.dataset.tab) {
                var tabName = trigger.dataset.tab;
                // Ensure the correct panel stays visible after HTMX refresh
                document.querySelectorAll('.tab-panel').forEach(function(panel) {
                    panel.classList.remove('active');
                });
                var panel = document.getElementById('tab-content-' + tabName);
                if (panel) panel.classList.add('active');
            }
        });
    })();
    </script>
    {% endif %}
</body>
</html>
