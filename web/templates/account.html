<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="robots" content="noindex, nofollow">
    <title>My Account â€” sfpermits.ai</title>
    <script nonce="{{ csp_nonce }}" src="/static/htmx.min.js"></script>
    <style nonce="{{ csp_nonce }}">
        :root {
            --bg: #0f1117;
            --surface: #1a1d27;
            --surface-2: #252834;
            --border: #333749;
            --text: #e4e6eb;
            --text-muted: #8b8fa3;
            --accent: #4f8ff7;
            --accent-hover: #3a7ae0;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
        }
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg);
            color: var(--text);
            line-height: 1.6;
            min-height: 100vh;
        }
        .container { max-width: 800px; margin: 0 auto; padding: 0 24px; }
        header {
            border-bottom: 1px solid var(--border);
            padding: 20px 0;
        }
        header .container {
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .logo {
            font-size: 1.4rem;
            font-weight: 700;
            color: var(--accent);
            text-decoration: none;
        }
        .logo span { color: var(--text-muted); font-weight: 400; }
        .header-right {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        .badge {
            font-size: 0.7rem;
            background: var(--surface-2);
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: 12px;
            border: 1px solid var(--border);
            text-decoration: none;
        }
        .badge-btn {
            cursor: pointer;
            font-family: inherit;
        }
        .badge-btn:hover { color: var(--text); border-color: var(--text-muted); }
        main { padding: 40px 0 80px; }
        h1 { font-size: 1.5rem; margin-bottom: 8px; }
        .subtitle { color: var(--text-muted); margin-bottom: 32px; }
        .card {
            background: var(--surface);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }
        .card h2 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            color: var(--accent);
        }
        .info-row {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid var(--border);
        }
        .info-row:last-child { border-bottom: none; }
        .info-label { color: var(--text-muted); }
        .watch-list { list-style: none; }
        .watch-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid var(--border);
        }
        .watch-item:last-child { border-bottom: none; }
        .watch-meta {
            display: flex;
            flex-direction: column;
        }
        .watch-label { font-weight: 500; }
        .watch-type {
            font-size: 0.8rem;
            color: var(--text-muted);
            text-transform: uppercase;
        }
        .btn-unwatch {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-unwatch:hover { color: var(--error); border-color: var(--error); }
        .btn-edit {
            background: none;
            border: 1px solid var(--border);
            color: var(--text-muted);
            padding: 4px 10px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.8rem;
        }
        .btn-edit:hover { color: var(--accent); border-color: var(--accent); }
        .watch-search {
            width: 100%;
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
            margin-bottom: 16px;
        }
        .watch-search::placeholder { color: var(--text-muted); }
        .watch-actions { display: flex; gap: 6px; align-items: center; flex-shrink: 0; }
        .watch-edit-input {
            padding: 4px 8px;
            background: var(--surface-2);
            border: 1px solid var(--accent);
            border-radius: 4px;
            color: var(--text);
            font-size: 0.85rem;
            width: 200px;
        }
        .watch-add-form {
            display: flex;
            gap: 8px;
            align-items: center;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border);
        }
        .watch-add-form input, .watch-add-form select {
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.85rem;
        }
        .watch-add-form button {
            padding: 8px 16px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.85rem;
        }
        .watch-item.hidden { display: none; }
        .tag-pill {
            display: inline-block;
            background: rgba(79, 143, 247, 0.15);
            color: var(--accent);
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7rem;
            margin-right: 4px;
        }
        .tag-editor { margin-top: 4px; }
        .empty { color: var(--text-muted); font-style: italic; }
        .impersonate-banner {
            background: rgba(251, 191, 36, 0.15);
            border: 1px solid var(--warning);
            color: var(--warning);
            text-align: center;
            padding: 8px;
            font-size: 0.85rem;
        }
        .impersonate-banner form { display: inline; }
        .impersonate-banner button {
            background: none;
            border: 1px solid var(--warning);
            color: var(--warning);
            padding: 2px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.8rem;
            margin-left: 8px;
        }
        .admin-section {
            margin-top: 32px;
        }
        .htmx-indicator { display: none; }
        .htmx-request .htmx-indicator, .htmx-request.htmx-indicator { display: inline; }
        .admin-section input[type="email"] {
            padding: 8px 12px;
            background: var(--surface-2);
            border: 1px solid var(--border);
            border-radius: 6px;
            color: var(--text);
            font-size: 0.9rem;
            width: 250px;
        }
        .admin-section .btn-sm {
            padding: 8px 16px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .btn-sm {
            padding: 8px 16px;
            background: var(--accent);
            color: #fff;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9rem;
        }
        .status-badge {
            display: inline-block;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.75rem;
            font-weight: 600;
        }
        .status-completed { background: #1b5e20; color: #a5d6a7; }
        .status-processing { background: #0d47a1; color: #90caf9; }
        .status-pending { background: #4a4a00; color: #fff9c4; }
        .status-failed { background: #b71c1c; color: #ef9a9a; }
        .status-stale { background: #e65100; color: #ffcc80; }

        /* Tab bar (admin only) */
        .tab-bar { display: flex; gap: 6px; margin-bottom: 24px; flex-wrap: wrap; }
        .tab-btn { padding: 7px 16px; border-radius: 6px; font-size: 0.8rem; border: 1px solid var(--border); background: var(--surface-2); color: var(--text-muted); cursor: pointer; font-family: inherit; text-decoration: none; transition: all 0.15s; }
        .tab-btn:hover { border-color: var(--text-muted); color: var(--text); }
        .tab-btn.active { background: var(--accent); color: #fff; border-color: var(--accent); }
        .tab-btn.loading {
            color: var(--accent) !important;
            background: var(--surface-2) !important;
            border-color: var(--accent) !important;
            animation: tab-pulse 0.5s ease-in-out infinite alternate;
        }
        @keyframes tab-pulse { from { border-color: rgba(79,143,247,0.3); } to { border-color: rgba(79,143,247,1); } }
        #tab-content { min-height: 200px; }
        .tab-loading { text-align: center; padding: 60px 0; color: var(--text-muted); font-size: 0.9rem; }
        .tab-loading-spinner { display: inline-block; width: 20px; height: 20px; border: 2px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.7s linear infinite; margin-right: 8px; vertical-align: middle; }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Tab panel visibility */
        .tab-panel { display: none; }
        .tab-panel.active { display: block; }
    </style>
    <link rel="stylesheet" href="/static/style.css">
    <link rel="stylesheet" href="/static/mobile.css">
</head>
<body hx-headers='{"X-CSRFToken": "{{ csrf_token }}"}'>
    {% if session.get('impersonating') %}
    <div class="impersonate-banner">
        Viewing as {{ session.impersonating }}
        <form method="POST" action="/auth/stop-impersonate">
            <input type="hidden" name="csrf_token" value="{{ csrf_token }}">
            <button type="submit">Stop impersonating</button>
        </form>
    </div>
    {% endif %}

    {% set active_page = 'account' %}
    {% include 'fragments/nav.html' %}

    <main>
        <div class="container">
            <h1>My Account</h1>
            <p class="subtitle">{{ user.email }}</p>

            {% if user.is_admin %}
            <!-- Admin users: tab bar with visual separator between Settings and Admin -->
            <div class="tab-bar tab-bar-divided" id="tab-bar">
                <button class="tab-btn active" data-tab="settings"
                        hx-get="/account/fragment/settings"
                        hx-target="#tab-content-settings"
                        hx-swap="innerHTML"
                        onclick="switchTab('settings')">Settings</button>
                <span class="tab-divider"></span>
                <button class="tab-btn" data-tab="admin"
                        hx-get="/account/fragment/admin"
                        hx-target="#tab-content-admin"
                        hx-swap="innerHTML"
                        onclick="switchTab('admin')">Admin<span class="tab-admin-badge">Admin</span></button>
            </div>
            <!-- Settings tab: pre-rendered server-side -->
            <div id="tab-content-settings" class="tab-panel active">
                {% include 'fragments/account_settings.html' %}
            </div>
            <!-- Admin tab: pre-rendered server-side -->
            <div id="tab-content-admin" class="tab-panel">
                {% include 'fragments/account_admin.html' %}
            </div>
            {% else %}
            <!-- Non-admin users: settings content rendered directly (no tab bar needed) -->
            {% include 'fragments/account_settings.html' %}
            {% endif %}
        </div>
    </main>

    {% include 'fragments/feedback_widget.html' %}

    {% if user.is_admin %}
    <script nonce="{{ csp_nonce }}">
    (function() {
        var activeTab = 'settings';

        // Read hash on load to restore tab state
        var hash = location.hash.replace('#', '');
        if (hash === 'settings' || hash === 'admin') {
            activeTab = hash;
        }

        function switchTab(tabName) {
            // Update button states
            document.querySelectorAll('.tab-btn').forEach(function(btn) {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });
            // Update panel visibility
            document.querySelectorAll('.tab-panel').forEach(function(panel) {
                panel.classList.remove('active');
            });
            var panel = document.getElementById('tab-content-' + tabName);
            if (panel) panel.classList.add('active');
            // Persist to URL hash
            history.replaceState(null, '', '#' + tabName);
            activeTab = tabName;
        }

        // Make switchTab globally accessible (called from onclick)
        window.switchTab = switchTab;

        // Restore active tab from hash on page load
        if (activeTab !== 'settings') {
            switchTab(activeTab);
        }

        // After HTMX swaps fragment content, keep the panel visible
        document.body.addEventListener('htmx:afterSwap', function(evt) {
            var d = evt.detail || {};
            var trigger = d.elt || (d.requestConfig && d.requestConfig.elt) || null;
            if (trigger && trigger.dataset && trigger.dataset.tab) {
                var tabName = trigger.dataset.tab;
                // Ensure the correct panel stays visible after HTMX refresh
                document.querySelectorAll('.tab-panel').forEach(function(panel) {
                    panel.classList.remove('active');
                });
                var panel = document.getElementById('tab-content-' + tabName);
                if (panel) panel.classList.add('active');
            }
        });
    })();
    </script>
    {% endif %}
</body>
</html>
