<style>
.search-result-card table td a {
    color: var(--accent, #4f8ff7);
    text-decoration: underline;
}
.search-result-card table td a:hover {
    color: #7ab0ff;
}
</style>
<div class="result-card search-result-card">
    <div class="search-echo" style="display: flex; justify-content: space-between; align-items: center;">
        <span>{{ query_echo }}</span>
        {% if watch_data %}
        <span class="watch-container">
            {% if existing_watch_id %}
            {% include 'fragments/watch_confirmation.html' %}
            {% elif g.user %}
            {% include 'fragments/watch_button.html' %}
            {% else %}
            {% include 'fragments/login_prompt.html' %}
            {% endif %}
        </span>
        {% endif %}
    </div>

    {# Quick Actions - appears at TOP before results #}
    {% if not no_results and (report_url or street_address) %}
    <div style="margin-top:16px;margin-bottom:16px;padding:16px;background:rgba(79, 143, 247, 0.06);border:1px solid rgba(79, 143, 247, 0.2);border-radius:10px;">
        <div style="font-weight: 600; margin-bottom: 12px; color: var(--text);">Quick Actions</div>
        <div style="display: flex; flex-wrap: wrap; gap: 10px;">

            <!-- Primary: View Property Report -->
            {% if report_url %}
            <a href="{{ report_url }}"
               style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;background:var(--accent, #4f8ff7);color:#fff;text-decoration:none;border-radius:8px;font-weight:600;font-size:0.9rem;">
                üìä View Property Report
            </a>
            {% endif %}

            <!-- Analyze Project (prefill with real permit data if available) -->
            {% if street_address %}
            <form method="POST" action="/ask" style="display:inline;margin:0;">
                {% if project_context %}
                <input type="hidden" name="q" value="{{ project_context.description }}">
                <input type="hidden" name="estimated_cost" value="{{ project_context.estimated_cost or '' }}">
                <input type="hidden" name="neighborhood" value="{{ project_context.neighborhood or '' }}">
                {% else %}
                <input type="hidden" name="q" value="I want to analyze a project at {{ street_address }}">
                {% endif %}
                <button type="submit"
                    style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:8px;font-weight:600;font-size:0.9rem;cursor:pointer;font-family:inherit;">
                    üîç {% if project_context %}Analyze: {{ project_context.label }}{% else %}Analyze Project{% endif %}
                </button>
            </form>
            {% endif %}

            <!-- Check Violations ‚Äî 3 visual states based on data availability -->
            {% if street_address %}
            <form method="POST" action="/ask" style="display:inline;margin:0;">
                <input type="hidden" name="q" value="Are there any violations at {{ street_address }}?">
                <button type="submit" style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;border-radius:8px;font-weight:600;font-size:0.9rem;cursor:pointer;font-family:inherit;
                    {% if violation_counts and violation_counts.total > 0 %}
                        background:rgba(239,68,68,0.1);color:#f87171;border:1px solid rgba(239,68,68,0.35);
                    {% elif violation_counts %}
                        background:rgba(52,211,153,0.08);color:#6ee7b7;border:1px solid rgba(52,211,153,0.25);
                    {% else %}
                        background:var(--surface);color:var(--text);border:1px solid var(--border);
                    {% endif %}
                ">
                    {% if violation_counts and violation_counts.total > 0 %}
                        ‚ö†Ô∏è Check Violations ¬∑ {{ violation_counts.total }} open
                    {% elif violation_counts %}
                        ‚úì No open violations
                    {% else %}
                        ‚ö†Ô∏è Check Violations
                    {% endif %}
                </button>
            </form>
            {% endif %}

            <!-- Who's Here ‚Äî only shown when businesses data is available -->
            {% if active_businesses and street_address %}
            <form method="POST" action="/ask" style="display:inline;margin:0;">
                <input type="hidden" name="q" value="Who is operating at {{ street_address }}?">
                <button type="submit"
                    style="display:inline-flex;align-items:center;gap:6px;padding:10px 20px;background:var(--surface);color:var(--text);border:1px solid var(--border);border-radius:8px;font-weight:600;font-size:0.9rem;cursor:pointer;font-family:inherit;">
                    üè¢ Who's Here
                    {% if active_businesses|length == 1 %}¬∑ {{ active_businesses[0].name[:22] }}
                    {% else %}¬∑ {{ active_businesses|length }} businesses{% endif %}
                </button>
            </form>
            {% endif %}

        </div>
    </div>
    {% endif %}

    {# Active businesses row ‚Äî only shown when businesses table is populated #}
    {% if active_businesses %}
    <div style="margin-bottom:16px;padding:12px 16px;background:rgba(52,211,153,0.05);border:1px solid rgba(52,211,153,0.18);border-radius:10px;">
        <div style="font-size:0.7rem;color:var(--text-muted);text-transform:uppercase;letter-spacing:0.06em;margin-bottom:8px;">Active at this address</div>
        <div style="display:flex;flex-direction:column;gap:5px;">
            {% for b in active_businesses %}
            <div style="display:flex;align-items:center;gap:8px;font-size:0.88rem;">
                <span>üè¢</span>
                <span style="color:var(--text);">{{ b.name }}</span>
                <span style="color:var(--text-muted);font-size:0.78rem;">since {{ b.since }}</span>
                {% if b.type_flag %}
                <span style="font-size:0.72rem;padding:1px 6px;background:rgba(79,143,247,0.12);border-radius:4px;color:var(--accent);">{{ b.type_flag }}</span>
                {% endif %}
            </div>
            {% endfor %}
        </div>
    </div>
    {% endif %}

    {{ result_html | safe }}
    {% if no_results and no_results_address %}
    <div style="margin-top: 20px; padding: 20px; background: rgba(79, 143, 247, 0.06); border: 1px solid rgba(79, 143, 247, 0.2); border-radius: 10px;">
        {# ===== Fuzzy suggestions: "Did you mean...?" ===== #}
        {% if fuzzy_suggestions %}
        <div style="font-weight: 600; margin-bottom: 10px;">Did you mean?</div>
        <div style="display: flex; flex-direction: column; gap: 6px; margin-bottom: 16px;">
            {% for s in fuzzy_suggestions %}
            <form method="POST" action="/ask" style="display:inline;margin:0;padding:0;">
                <input type="hidden" name="q" value="{{ s.street_number }} {{ s.full_name }}">
                <button type="submit"
                    style="display:inline-flex;align-items:center;gap:8px;color:#4f8ff7;background:none;border:none;cursor:pointer;padding:4px 0;font-family:inherit;font-size:0.95rem;text-align:left;">
                    <span style="font-size:0.9rem;">&#x27A4;</span>
                    {{ s.street_number }} {{ s.full_name }}
                    <span style="color:#8b8fa3;font-size:0.8rem;">({{ s.count }} permits)</span>
                </button>
            </form>
            {% endfor %}
        </div>
        <div style="border-top:1px solid rgba(79,143,247,0.15);padding-top:12px;margin-top:4px;">
        {% endif %}
        <div style="font-weight: 600; margin-bottom: 8px;">What you can do next</div>
        <div style="display: flex; flex-direction: column; gap: 10px;">
            {% if report_url %}
            <a href="{{ report_url }}"
               style="display: inline-flex; align-items: center; gap: 8px; color: #4f8ff7; text-decoration: none; font-weight: 600; font-size: 0.95rem;">
                <span style="font-size: 1.1rem;">&#x1F4CA;</span> Run Property Report
            </a>
            {% endif %}
            <a href="/?q={{ no_results_address }}"
               style="display: inline-flex; align-items: center; gap: 8px; color: #8b8fa3; text-decoration: none; font-size: 0.9rem;">
                <span style="font-size: 1.1rem;">&#x1F50D;</span> Try a different search
            </a>
            <span style="color: #8b8fa3; font-size: 0.85rem; margin-top: 4px;">
                No permit history doesn't mean no permits are required &mdash; it may just mean no permits have been filed yet at this address.
            </span>
        </div>
        {% if fuzzy_suggestions %}
        </div>
        {% endif %}
    </div>
    {% elif not no_results %}
    {# ===== Neighborhood stats card ===== #}
    {% if hood_stats %}
    <div style="margin-top:12px;padding:14px 18px;background:var(--surface, #1a1d27);border:1px solid var(--border, #333749);border-radius:8px;">
        <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
            <span style="font-weight:600;font-size:0.9rem;color:var(--text, #e4e6eb);">{{ hood_stats.name }}</span>
            <span style="font-size:0.75rem;color:var(--text-muted, #8b8fa3);">neighborhood</span>
        </div>
        <div style="display:flex;gap:20px;flex-wrap:wrap;">
            <div>
                <div style="font-size:1.1rem;font-weight:700;color:var(--accent, #4f8ff7);">{{ "{:,}".format(hood_stats.total_permits) }}</div>
                <div style="font-size:0.7rem;color:var(--text-muted, #8b8fa3);text-transform:uppercase;">total permits</div>
            </div>
            <div>
                <div style="font-size:1.1rem;font-weight:700;color:var(--success, #34d399);">{{ "{:,}".format(hood_stats.active_permits) }}</div>
                <div style="font-size:0.7rem;color:var(--text-muted, #8b8fa3);text-transform:uppercase;">active</div>
            </div>
            {% if hood_stats.top_types %}
            <div style="flex:1;min-width:160px;">
                <div style="font-size:0.7rem;color:var(--text-muted, #8b8fa3);text-transform:uppercase;margin-bottom:4px;">top permit types</div>
                {% for t in hood_stats.top_types %}
                <div style="font-size:0.8rem;color:var(--text, #e4e6eb);display:flex;justify-content:space-between;gap:8px;">
                    <span style="overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">{{ t.type }}</span>
                    <span style="color:var(--text-muted, #8b8fa3);flex-shrink:0;">{{ "{:,}".format(t.count) }}</span>
                </div>
                {% endfor %}
            </div>
            {% endif %}
        </div>
    </div>
    {% endif %}
    {% endif %}
    {% if show_primary_prompt and prompt_street_number %}
    {% include 'fragments/primary_address_prompt.html' %}
    {% endif %}
</div>
