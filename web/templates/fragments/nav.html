<style nonce="{{ csp_nonce }}">
    header { border-bottom: 1px solid var(--border); padding: 20px 0; }
    header .container { display: flex; align-items: center; justify-content: space-between; }
    .logo { font-size: 1.4rem; font-weight: 700; color: var(--accent); text-decoration: none; }
    .logo span { color: var(--text-muted); font-weight: 400; }
    .header-right { display: flex; align-items: center; gap: 10px; }
    .badge {
        font-size: 0.7rem; background: var(--surface-2); color: var(--text-muted);
        padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border);
        text-decoration: none; cursor: pointer; font-family: inherit;
    }
    .badge:hover { color: var(--text); border-color: var(--text-muted); }
    .badge-active { background: var(--accent) !important; color: #fff !important; border-color: var(--accent) !important; }
    .badge-btn {
        cursor: pointer; font-family: inherit; font-size: 0.7rem;
        background: var(--surface-2); color: var(--text-muted);
        padding: 4px 10px; border-radius: 12px; border: 1px solid var(--border);
    }
    .badge-btn:hover { color: var(--text); border-color: var(--text-muted); }
    .badge-loading {
        color: var(--accent) !important;
        animation: nav-pulse 0.5s ease-in-out infinite alternate;
    }
    @keyframes nav-pulse {
        from { border-color: rgba(79,143,247,0.3); }
        to   { border-color: rgba(79,143,247,1); }
    }
    /* Admin dropdown */
    .admin-dropdown {
        position: relative;
        display: inline-block;
    }
    .admin-dropdown-menu {
        display: none;
        position: absolute;
        right: 0;
        top: 100%;
        padding-top: 6px;       /* invisible bridge covers the hover gap */
        min-width: 200px;
        z-index: 1000;
    }
    .admin-dropdown-menu-inner {
        background: var(--surface);
        border: 1px solid var(--border);
        border-radius: 10px;
        padding: 6px 0;
        box-shadow: 0 8px 24px rgba(0,0,0,0.4);
    }
    .admin-dropdown:hover .admin-dropdown-menu,
    .admin-dropdown:focus-within .admin-dropdown-menu {
        display: block;
    }
    .admin-dropdown-menu-inner a {
        display: block;
        padding: 8px 16px;
        color: var(--text-muted);
        text-decoration: none;
        font-size: 0.75rem;
        white-space: nowrap;
    }
    .admin-dropdown-menu-inner a:hover {
        color: var(--text);
        background: var(--surface-2);
    }
</style>
<header>
    <div class="container">
        <a href="/" class="logo">sfpermits<span>.ai</span></a>
        <div class="header-right">
            <a href="/" class="badge {% if active_page == 'search' %}badge-active{% endif %}">Search</a>
            {% if gate.can_brief %}
            <a href="/brief" class="badge {% if active_page == 'brief' %}badge-active{% endif %}">Brief</a>
            {% else %}
            <a href="/auth/login" class="badge" style="opacity:0.5;" title="Sign up to access Morning Brief">Brief <span style="font-size:0.6rem;background:var(--accent);color:#fff;padding:1px 5px;border-radius:4px;margin-left:3px;">Sign up</span></a>
            {% endif %}
            {% if gate.can_portfolio %}
            <a href="/portfolio" class="badge {% if active_page == 'portfolio' %}badge-active{% endif %}">Portfolio</a>
            {% else %}
            <a href="/auth/login" class="badge" style="opacity:0.5;" title="Sign up to access Portfolio">Portfolio <span style="font-size:0.6rem;background:var(--accent);color:#fff;padding:1px 5px;border-radius:4px;margin-left:3px;">Sign up</span></a>
            {% endif %}
            {% if gate.can_projects %}
            <a href="/projects" class="badge {% if active_page == 'projects' %}badge-active{% endif %}">Projects</a>
            {% else %}
            <a href="/auth/login" class="badge" style="opacity:0.5;" title="Sign up to access Projects">Projects <span style="font-size:0.6rem;background:var(--accent);color:#fff;padding:1px 5px;border-radius:4px;margin-left:3px;">Sign up</span></a>
            {% endif %}
            {% if gate.can_analyses %}
            <a href="/account/analyses" class="badge {% if active_page == 'analyses' %}badge-active{% endif %}">My Analyses</a>
            {% else %}
            <a href="/auth/login" class="badge" style="opacity:0.5;" title="Sign up to access My Analyses">My Analyses <span style="font-size:0.6rem;background:var(--accent);color:#fff;padding:1px 5px;border-radius:4px;margin-left:3px;">Sign up</span></a>
            {% endif %}
            {% if g.user and g.user.is_admin %}
            <div class="admin-dropdown">
                <span class="badge {% if active_page == 'admin' %}badge-active{% endif %}" tabindex="0">&#9881;&#65039; Admin &#9662;</span>
                <div class="admin-dropdown-menu">
                    <div class="admin-dropdown-menu-inner">
                        <a href="/admin/ops#pipeline">Pipeline Health</a>
                        <a href="/admin/ops#quality">Data Quality</a>
                        <a href="/admin/ops#activity">User Activity</a>
                        <a href="/admin/ops#feedback">Feedback</a>
                        <a href="/admin/ops#sources">LUCK Sources</a>
                        <a href="/admin/ops#regulatory">Regulatory Watch</a>
                        <a href="/admin/qa">QA Replays</a>
                    </div>
                </div>
            </div>
            {% endif %}
            {% if g.user %}
            <a href="/account" class="badge {% if active_page == 'account' %}badge-active{% endif %}">{{ g.user.display_name or g.user.email }}</a>
            <form action="/auth/logout" method="post" style="display:inline;">
                <button class="badge badge-btn" type="submit">Logout</button>
            </form>
            {% else %}
            <a href="/auth/login" class="badge">Sign in</a>
            {% endif %}
        </div>
    </div>
</header>
<script nonce="{{ csp_nonce }}">
(function() {
    // Immediately highlight nav link on click while next page loads
    document.querySelectorAll('header .badge[href]').forEach(function(link) {
        link.addEventListener('click', function() {
            // Don't animate if already on this page
            if (this.classList.contains('badge-active')) return;
            this.classList.add('badge-loading');
        });
    });
})();
</script>
