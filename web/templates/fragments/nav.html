<style nonce="{{ csp_nonce }}">
    /* ── Token vars — ensure obsidian tokens available even on non-migrated pages ─── */
    :root {
        --obsidian:       #0a0a0f;
        --obsidian-mid:   #12121a;
        --glass-border:   rgba(255, 255, 255, 0.06);
        --glass-hover:    rgba(255, 255, 255, 0.10);
        --glass:          rgba(255, 255, 255, 0.04);
        --accent:         #5eead4;
        --accent-glow:    rgba(94, 234, 212, 0.08);
        --accent-ring:    rgba(94, 234, 212, 0.30);
        --text-primary:   rgba(255, 255, 255, 0.92);
        --text-secondary: rgba(255, 255, 255, 0.55);
        --text-tertiary:  rgba(255, 255, 255, 0.30);
        --mono: 'JetBrains Mono', ui-monospace, 'Cascadia Code', monospace;
        --sans: 'IBM Plex Sans', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
        --space-1:  4px;
        --space-2:  8px;
        --space-3:  12px;
        --space-4:  16px;
        --text-xs:  clamp(0.65rem, 0.6rem + 0.2vw, 0.75rem);
        --text-sm:  clamp(0.75rem, 0.7rem + 0.25vw, 0.875rem);
        --text-base: clamp(0.8125rem, 0.75rem + 0.3vw, 1rem);
        --radius-sm:   6px;
        --radius-md:   12px;
        --radius-full: 9999px;
    }

    /* ── Floating Nav ─────────────────────────────────────────────────────── */
    .nav-float {
        position: sticky;
        top: 0;
        z-index: 100;
        background: rgba(0, 0, 0, 0.85);
        backdrop-filter: blur(12px);
        -webkit-backdrop-filter: blur(12px);
        border-bottom: 1px solid var(--glass-border);
    }
    .nav-float__inner {
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: var(--space-3) 0;
        gap: var(--space-4);
    }
    .nav-float__wordmark {
        font-family: var(--mono);
        font-size: var(--text-sm);
        font-weight: 300;
        letter-spacing: 0.35em;
        text-transform: uppercase;
        color: var(--text-tertiary);
        text-decoration: none;
        flex-shrink: 0;
    }
    .nav-float__wordmark .logo-dim {
        color: var(--text-tertiary);
        opacity: 0.6;
    }

    /* Desktop nav items */
    .nav-float__items {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        flex-wrap: nowrap;
    }
    .nav-float__right {
        display: flex;
        align-items: center;
        gap: var(--space-2);
        flex-shrink: 0;
    }

    /* Nav badge pill */
    .nav-badge {
        display: inline-flex;
        align-items: center;
        gap: var(--space-1);
        font-family: var(--sans);
        font-size: var(--text-sm);
        font-weight: 400;
        color: var(--text-secondary);
        background: var(--glass);
        padding: 5px 12px;
        border-radius: var(--radius-full);
        border: 1px solid var(--glass-border);
        text-decoration: none;
        cursor: pointer;
        white-space: nowrap;
        transition: color 0.2s, border-color 0.2s, background 0.2s;
    }
    .nav-badge:hover {
        color: var(--text-primary);
        border-color: var(--glass-hover);
    }
    .nav-badge.nav-badge-active {
        background: var(--accent-glow);
        color: var(--accent);
        border-color: var(--accent-ring);
    }
    .nav-badge-loading {
        color: var(--accent) !important;
        animation: nav-pulse 0.5s ease-in-out infinite alternate;
    }
    @keyframes nav-pulse {
        from { border-color: var(--accent-ring); }
        to   { border-color: var(--accent); }
    }

    /* "More" dropdown */
    .nav-more-dropdown {
        position: relative;
        display: inline-block;
    }
    .nav-more-menu {
        display: none;
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        min-width: 200px;
        z-index: 1000;
    }
    .nav-more-menu-inner {
        background: var(--obsidian-mid);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 6px 0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    .nav-more-menu-inner a,
    .nav-more-menu-inner button {
        display: block;
        width: 100%;
        padding: 9px 16px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: var(--text-sm);
        font-family: var(--sans);
        font-weight: 400;
        white-space: nowrap;
        background: none;
        border: none;
        cursor: pointer;
        text-align: left;
        transition: color 0.15s, background 0.15s;
    }
    .nav-more-menu-inner a:hover,
    .nav-more-menu-inner button:hover {
        color: var(--text-primary);
        background: var(--glass);
    }
    .nav-more-dropdown:hover .nav-more-menu,
    .nav-more-dropdown:focus-within .nav-more-menu {
        display: block;
    }

    /* Admin dropdown (gear icon) */
    .nav-admin-dropdown {
        position: relative;
        display: inline-block;
    }
    .nav-admin-menu {
        display: none;
        position: absolute;
        right: 0;
        top: calc(100% + 6px);
        min-width: 220px;
        z-index: 1000;
    }
    .nav-admin-menu-inner {
        background: var(--obsidian-mid);
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-md);
        padding: 6px 0;
        box-shadow: 0 8px 32px rgba(0, 0, 0, 0.5);
    }
    .nav-admin-menu-inner a {
        display: block;
        padding: 9px 16px;
        color: var(--text-secondary);
        text-decoration: none;
        font-size: var(--text-sm);
        white-space: nowrap;
        transition: color 0.15s, background 0.15s;
    }
    .nav-admin-menu-inner a:hover {
        color: var(--text-primary);
        background: var(--glass);
    }
    .nav-admin-dropdown:hover .nav-admin-menu,
    .nav-admin-dropdown:focus-within .nav-admin-menu {
        display: block;
    }

    /* Hamburger — mobile only */
    .nav-hamburger {
        display: none;
        background: none;
        border: 1px solid var(--glass-border);
        border-radius: var(--radius-sm);
        padding: 8px 10px;
        cursor: pointer;
        flex-direction: column;
        gap: 4px;
        flex-shrink: 0;
    }
    .nav-hamburger span {
        display: block;
        width: 20px;
        height: 2px;
        background: var(--text-secondary);
        border-radius: 2px;
        transition: transform 0.2s, opacity 0.2s;
    }
    .nav-hamburger.is-open span:nth-child(1) { transform: translateY(6px) rotate(45deg); }
    .nav-hamburger.is-open span:nth-child(2) { opacity: 0; }
    .nav-hamburger.is-open span:nth-child(3) { transform: translateY(-6px) rotate(-45deg); }

    /* Mobile slide-down panel */
    .nav-mobile-panel {
        display: none;
        flex-direction: column;
        border-top: 1px solid var(--glass-border);
        padding: var(--space-3) 0;
        gap: var(--space-1);
    }
    .nav-mobile-panel.is-open {
        display: flex;
    }
    .nav-mobile-panel a,
    .nav-mobile-panel button {
        display: flex;
        align-items: center;
        padding: 0 var(--space-4);
        min-height: 48px;
        font-family: var(--sans);
        font-size: var(--text-base);
        font-weight: 400;
        color: var(--text-secondary);
        text-decoration: none;
        background: none;
        border: none;
        cursor: pointer;
        border-radius: var(--radius-sm);
        transition: color 0.15s, background 0.15s;
        text-align: left;
        width: 100%;
    }
    .nav-mobile-panel a:hover,
    .nav-mobile-panel button:hover {
        color: var(--text-primary);
        background: var(--glass);
    }
    .nav-mobile-panel a.nav-badge-active {
        color: var(--accent);
    }
    .nav-mobile-divider {
        height: 1px;
        background: var(--glass-border);
        margin: var(--space-2) var(--space-4);
    }
    .nav-signup-chip {
        display: inline-flex;
        align-items: center;
        font-size: var(--text-xs);
        background: var(--accent-glow);
        color: var(--accent);
        padding: 2px 6px;
        border-radius: var(--radius-sm);
        margin-left: var(--space-2);
        font-weight: 400;
        text-transform: uppercase;
        letter-spacing: 0.05em;
        font-family: var(--mono);
        border: 1px solid var(--accent-ring);
    }

    /* Desktop: hide hamburger, show nav-items */
    @media (min-width: 769px) {
        .nav-hamburger { display: none !important; }
        .nav-float__items { display: flex !important; }
        .nav-mobile-panel { display: none !important; }
    }

    /* Mobile: show hamburger, hide desktop nav-items */
    @media (max-width: 768px) {
        .nav-float__items { display: none !important; }
        .nav-hamburger { display: flex !important; }
        .nav-float__right { display: none !important; }
    }
</style>

<nav class="nav-float" id="obs-nav">
    <div class="obs-container">
        <div class="nav-float__inner">
            <a href="/" class="nav-float__wordmark">sfpermits<span class="logo-dim">.ai</span></a>

            {# Desktop nav items — max 5 visible badges #}
            <div class="nav-float__items">
                <a href="/" class="nav-badge {% if active_page == 'search' %}nav-badge-active{% endif %}">Search</a>

                {% if gate.can_brief %}
                <a href="/brief" class="nav-badge {% if active_page == 'brief' %}nav-badge-active{% endif %}">Brief</a>
                {% else %}
                <a href="/auth/login" class="nav-badge" title="Sign up to access Morning Brief">
                    Brief <span class="nav-signup-chip">Sign up</span>
                </a>
                {% endif %}

                {% if gate.can_portfolio %}
                <a href="/portfolio" class="nav-badge {% if active_page == 'portfolio' %}nav-badge-active{% endif %}">Portfolio</a>
                {% else %}
                <a href="/auth/login" class="nav-badge" title="Sign up to access Portfolio">
                    Portfolio <span class="nav-signup-chip">Sign up</span>
                </a>
                {% endif %}

                {% if gate.can_projects %}
                <a href="/projects" class="nav-badge {% if active_page == 'projects' %}nav-badge-active{% endif %}">Projects</a>
                {% else %}
                <a href="/auth/login" class="nav-badge" title="Sign up to access Projects">
                    Projects <span class="nav-signup-chip">Sign up</span>
                </a>
                {% endif %}

                {# "More" dropdown — secondary nav items #}
                <div class="nav-more-dropdown" id="nav-more-dropdown">
                    <button class="nav-badge">More ▾</button>
                    <div class="nav-more-menu" id="nav-more-menu">
                        <div class="nav-more-menu-inner">
                            {% if gate.can_analyses %}
                            <a href="/account/analyses" class="{% if active_page == 'analyses' %}nav-badge-active{% endif %}">My Analyses</a>
                            {% else %}
                            <a href="/auth/login" title="Sign up for My Analyses">My Analyses <span class="nav-signup-chip">Sign up</span></a>
                            {% endif %}
                            {% if g.user %}
                            <a href="/account/prep" class="{% if active_page == 'prep' %}nav-badge-active{% endif %}">Permit Prep</a>
                            {% endif %}
                            <a href="/consultants">Consultants</a>
                            <a href="/bottlenecks">Bottlenecks</a>
                        </div>
                    </div>
                </div>
            </div>

            {# Right side: admin + account #}
            <div class="nav-float__right">
                {% if g.user and g.user.is_admin %}
                <div class="nav-admin-dropdown">
                    <button class="nav-badge {% if active_page == 'admin' %}nav-badge-active{% endif %}" tabindex="0">Admin ▾</button>
                    <div class="nav-admin-menu">
                        <div class="nav-admin-menu-inner">
                            <a href="/admin/ops#pipeline">Pipeline Health</a>
                            <a href="/admin/ops#quality">Data Quality</a>
                            <a href="/admin/ops#activity">User Activity</a>
                            <a href="/admin/ops#feedback">Feedback</a>
                            <a href="/admin/ops#sources">LUCK Sources</a>
                            <a href="/admin/ops#regulatory">Regulatory Watch</a>
                            <a href="/admin/qa">QA Replays</a>
                        </div>
                    </div>
                </div>
                {% endif %}

                {% if g.user %}
                <a href="/account" class="nav-badge {% if active_page == 'account' %}nav-badge-active{% endif %}">{{ g.user.display_name or g.user.email }}</a>
                <form action="/auth/logout" method="post" style="display:inline;">
                    <button class="nav-badge" type="submit">Logout</button>
                </form>
                {% else %}
                <a href="/auth/login" class="nav-badge">Sign in</a>
                {% endif %}
            </div>

            {# Hamburger button — mobile only #}
            <button class="nav-hamburger" id="nav-hamburger" aria-label="Toggle navigation" aria-expanded="false">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>

        {# Mobile slide-down panel #}
        <div class="nav-mobile-panel" id="nav-mobile-panel">
            <a href="/" class="{% if active_page == 'search' %}nav-badge-active{% endif %}">Search</a>

            {% if gate.can_brief %}
            <a href="/brief" class="{% if active_page == 'brief' %}nav-badge-active{% endif %}">Brief</a>
            {% else %}
            <a href="/auth/login">Brief <span class="nav-signup-chip">Sign up</span></a>
            {% endif %}

            {% if gate.can_portfolio %}
            <a href="/portfolio" class="{% if active_page == 'portfolio' %}nav-badge-active{% endif %}">Portfolio</a>
            {% else %}
            <a href="/auth/login">Portfolio <span class="nav-signup-chip">Sign up</span></a>
            {% endif %}

            {% if gate.can_projects %}
            <a href="/projects" class="{% if active_page == 'projects' %}nav-badge-active{% endif %}">Projects</a>
            {% else %}
            <a href="/auth/login">Projects <span class="nav-signup-chip">Sign up</span></a>
            {% endif %}

            {% if gate.can_analyses %}
            <a href="/account/analyses" class="{% if active_page == 'analyses' %}nav-badge-active{% endif %}">My Analyses</a>
            {% else %}
            <a href="/auth/login">My Analyses <span class="nav-signup-chip">Sign up</span></a>
            {% endif %}

            {% if g.user %}
            <a href="/account/prep" class="{% if active_page == 'prep' %}nav-badge-active{% endif %}">Permit Prep</a>
            {% endif %}

            <a href="/consultants">Consultants</a>
            <a href="/bottlenecks">Bottlenecks</a>

            <div class="nav-mobile-divider"></div>

            {% if g.user and g.user.is_admin %}
            <a href="/admin/ops">Admin Dashboard</a>
            {% endif %}

            {% if g.user %}
            <a href="/account" class="{% if active_page == 'account' %}nav-badge-active{% endif %}">{{ g.user.display_name or g.user.email }}</a>
            <form action="/auth/logout" method="post">
                <button type="submit">Logout</button>
            </form>
            {% else %}
            <a href="/auth/login">Sign in</a>
            {% endif %}
        </div>
    </div>
</nav>

<script nonce="{{ csp_nonce }}">
(function() {
    // Loading state on nav badge click
    document.querySelectorAll('.nav-badge[href]').forEach(function(link) {
        link.addEventListener('click', function() {
            if (this.classList.contains('nav-badge-active')) return;
            this.classList.add('nav-badge-loading');
        });
    });

    // Hamburger toggle
    var hamburger = document.getElementById('nav-hamburger');
    var mobilePanel = document.getElementById('nav-mobile-panel');

    if (hamburger && mobilePanel) {
        hamburger.addEventListener('click', function() {
            var isOpen = mobilePanel.classList.toggle('is-open');
            hamburger.classList.toggle('is-open', isOpen);
            hamburger.setAttribute('aria-expanded', isOpen ? 'true' : 'false');
        });

        // Close on tap outside
        document.addEventListener('click', function(e) {
            var nav = document.getElementById('obs-nav');
            if (nav && !nav.contains(e.target)) {
                mobilePanel.classList.remove('is-open');
                hamburger.classList.remove('is-open');
                hamburger.setAttribute('aria-expanded', 'false');
            }
        });
    }
})();
</script>
