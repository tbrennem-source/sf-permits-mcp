{# showcase_gantt.html — Station Timeline Gantt (parallel-aware) #}
{# Receives: showcase.station_timeline #}
{% if showcase and showcase.station_timeline %}
{% set gantt = showcase.station_timeline %}
{# Calculate total months from axis_labels count or fallback to 6 #}
{% set total_months = (gantt.axis_labels | length) if gantt.axis_labels else 6 %}
<div class="bg-glass border border-glass-border rounded-lg overflow-hidden mb-4 reveal reveal-d2">

  <style>
    /* Bar status colors (matching landing-v6 mockup) */
    .bar-done      { background: rgba(74,222,128,0.7); }
    .bar-approved  { background: rgba(74,222,128,0.7); }
    .bar-approved-bar  { background: rgba(74,222,128,0.7); }
    .bar-active    { background: #fbbf24; opacity: 0.85; }
    .bar-stalled   { background: #f87171; opacity: 0.85; }
    .bar-comments  { background: rgba(245,158,11,0.55); }
    .bar-projected {
      background: repeating-linear-gradient(
        90deg,
        rgba(255,255,255,0.08) 0px, rgba(255,255,255,0.08) 4px,
        transparent 4px, transparent 8px
      );
    }
    .gantt-status-dot-done     { background: rgba(74,222,128,0.7); }
    .gantt-status-dot-approved { background: rgba(74,222,128,0.7); }
    .gantt-status-dot-active   { background: #fbbf24; }
    .gantt-status-dot-stalled  { background: #f87171; }
    .gantt-status-dot-comments { background: rgba(245,158,11,0.7); }
    .gantt-status-dot-projected { background: rgba(255,255,255,0.2); }
  </style>

  <!-- Title bar -->
  <div class="flex items-center justify-between px-4 py-3 border-b border-glass-border flex-wrap gap-2">
    <div class="flex items-center gap-3">
      <a href="/analyze?q={{ gantt.address | urlencode }}" class="font-mono text-[13px] font-light text-accent hover:underline">
        {{ gantt.address or '350 Mission St' }}
      </a>
      {% if gantt.permit_type %}
      <span class="font-mono text-xs text-white/45 tracking-wide hidden md:inline">{{ gantt.permit_type }}</span>
      {% endif %}
    </div>
    <div class="flex items-center gap-2">
      <span class="font-mono text-[11px] text-white/25">{{ gantt.total_days }} days total</span>
    </div>
  </div>

  <!-- Legend -->
  <div class="flex gap-4 px-4 py-2 border-b border-glass-border flex-wrap">
    <div class="flex items-center gap-1.5 font-mono text-[10px] text-white/25">
      <span class="w-3.5 h-1 rounded-sm bar-done inline-block"></span> Done
    </div>
    <div class="flex items-center gap-1.5 font-mono text-[10px] text-white/25">
      <span class="w-3.5 h-1 rounded-sm bar-active inline-block"></span> In review
    </div>
    <div class="flex items-center gap-1.5 font-mono text-[10px] text-white/25">
      <span class="w-3.5 h-1 rounded-sm bar-stalled inline-block"></span> Stalled
    </div>
    <div class="flex items-center gap-1.5 font-mono text-[10px] text-white/25">
      <span class="w-3.5 h-1 rounded-sm bar-projected inline-block"></span> Projected
    </div>
  </div>

  <!-- Month axis -->
  <div class="grid grid-cols-[140px_1fr] md:grid-cols-[160px_1fr] py-1.5 border-b border-glass-border">
    <span></span>
    <div class="flex justify-between pr-2 font-mono text-[9px] text-white/25 tracking-wide">
      {% for label in gantt.axis_labels %}
      <span>{{ label }}</span>
      {% endfor %}
    </div>
  </div>

  <!-- Gantt body: each station on its own row (parallel stations appear at same horizontal position) -->
  <div class="relative">
    {% for station in gantt.stations %}
    {# Determine bar CSS class based on status #}
    {% set bar_class = 'bar-' + (station.status | lower | replace('approved', 'done') | replace('comments', 'active')) %}
    {# Calculate left % from start_month #}
    {% set left_pct = (station.start_month / total_months * 100) | round(2) %}
    <div class="grid grid-cols-[140px_1fr] md:grid-cols-[160px_1fr] items-center min-h-[28px] border-b border-white/[0.03] hover:bg-white/[0.02] transition-colors"
         title="{{ station.label or station.station }}{% if station.dwell_days %} · {{ station.dwell_days }}d{% endif %}{% if station.reviewer %} · {{ station.reviewer }}{% endif %}{% if station.is_current %} · current station{% endif %}">
      <!-- Station label -->
      <div class="flex items-center gap-2 px-3 py-1">
        <span class="w-1.5 h-1.5 rounded-full shrink-0 gantt-status-dot-{{ station.status | lower | replace('approved', 'done') }}"></span>
        <div>
          <div class="font-mono text-[11px] font-light {{ 'text-accent' if station.is_current else ('text-signal-amber' if station.status == 'stalled' else 'text-white/90') }}">
            {{ station.label or station.station }}
          </div>
          {% if station.dwell_days %}
          <div class="font-sans text-[9px] text-white/25 hidden md:block">
            {{ station.dwell_days }}d
            {% if station.status == 'approved' or station.status == 'done' %} ✓{% endif %}
            {% if station.addenda_number and station.addenda_number > 0 %} · addenda {{ station.addenda_number }}{% endif %}
          </div>
          {% endif %}
        </div>
        {% if station.is_current %}
        <span class="font-mono text-[8px] text-accent/60 bg-accent/5 border border-accent/10 px-1.5 py-px rounded-sm ml-auto">now</span>
        {% endif %}
      </div>
      <!-- Bar track: position is determined by start_month (parallel stations share the same x-position) -->
      <div class="relative py-1" style="height: 28px;">
        <div class="absolute top-1.5 h-3.5 rounded-[3px] {{ bar_class }}"
             style="left: {{ left_pct }}%; width: {{ station.width_pct | round(2) }}%; min-width: 2px;"
             title="{{ station.label or station.station }} · {{ station.dwell_days or '?' }}d{% if station.reviewer %} · {{ station.reviewer }}{% endif %}">
        </div>
        {% if station.is_current %}
        <span class="absolute top-0 font-mono text-[8px] text-accent whitespace-nowrap" style="left: calc({{ left_pct }}% + {{ station.width_pct | round(2) }}% - 2px);">▶</span>
        {% endif %}
      </div>
    </div>
    {% endfor %}

    <!-- Axis labels row (spacer + labels) -->
    <div class="grid grid-cols-[140px_1fr] md:grid-cols-[160px_1fr] mt-1">
      <div></div>
      <div class="flex justify-between pr-2 font-mono text-[9px] text-white/15 tracking-wide">
        {% for label in gantt.axis_labels %}
        <span>{{ loop.index }}</span>
        {% endfor %}
      </div>
    </div>
  </div>

  <!-- Projection footer -->
  {% if gantt.predicted_next %}
  <div class="flex items-baseline justify-between px-4 py-3 border-t border-glass-border">
    <span class="font-sans text-xs text-white/45">Next predicted station</span>
    <div class="text-right">
      <div class="font-mono text-sm font-light text-signal-amber">
        {{ gantt.predicted_next[0].label }}
        <span class="text-xs text-white/25 ml-1">~{{ gantt.predicted_next[0].p50_days }}d</span>
      </div>
      <div class="font-mono text-[10px] text-white/25 mt-0.5">{{ (gantt.predicted_next[0].probability * 100) | round | int }}% probability</div>
    </div>
  </div>
  {% endif %}

</div>
{% endif %}
