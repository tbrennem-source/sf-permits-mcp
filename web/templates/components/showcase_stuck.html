{# showcase_stuck.html — Stuck Permit Diagnosis (visual-first redesign) #}
{# Receives: showcase.stuck_permit (via Jinja2 global from routes_public.py) #}
{% if showcase and showcase.stuck_permit %}
{% set stuck = showcase.stuck_permit %}
<div class="showcase-card showcase-stuck"
     data-track="showcase-view"
     data-showcase="stuck">
  <style>
    @keyframes stuck-pulse {
      0%, 100% { opacity: 1; }
      50%       { opacity: 0.35; }
    }

    /* Card layout */
    .showcase-stuck { overflow: visible; }

    /* Header row */
    .stuck-header {
      display: flex;
      align-items: flex-start;
      justify-content: space-between;
      gap: var(--space-4);
      padding: var(--space-5) var(--space-5) 0;
    }
    .stuck-permit-id {
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 400;
      letter-spacing: 0.06em;
      color: var(--text-tertiary);
      margin-bottom: var(--space-1);
    }
    .stuck-address {
      font-family: var(--mono);
      font-size: var(--text-sm);
      color: var(--text-secondary);
    }
    .stuck-severity-badge {
      display: inline-flex;
      align-items: center;
      gap: var(--space-2);
      font-family: var(--mono);
      font-size: 10px;
      font-weight: 400;
      letter-spacing: 0.08em;
      text-transform: uppercase;
      flex-shrink: 0;
    }
    .stuck-severity-badge--critical {
      color: var(--signal-red);
      background: rgba(239, 68, 68, 0.08);
      border: 1px solid rgba(239, 68, 68, 0.22);
      padding: 4px 10px;
      border-radius: var(--radius-sm);
    }
    .stuck-severity-badge--high {
      color: var(--signal-amber);
      background: rgba(251, 191, 36, 0.08);
      border: 1px solid rgba(251, 191, 36, 0.22);
      padding: 4px 10px;
      border-radius: var(--radius-sm);
    }
    .stuck-dot {
      width: 6px;
      height: 6px;
      border-radius: var(--radius-full);
      flex-shrink: 0;
    }
    .stuck-dot--critical {
      background: var(--dot-red);
      animation: stuck-pulse 2s ease-in-out infinite;
    }
    .stuck-dot--high {
      background: var(--dot-amber);
    }

    /* Hero days stat */
    .stuck-hero {
      display: flex;
      align-items: flex-end;
      gap: var(--space-3);
      padding: var(--space-4) var(--space-5) var(--space-3);
    }
    .stuck-days-number {
      font-family: var(--mono);
      font-size: clamp(2.5rem, 5vw, 3.25rem);
      font-weight: 300;
      color: var(--signal-red);
      line-height: 1;
    }
    .stuck-days-label {
      font-family: var(--mono);
      font-size: var(--text-sm);
      color: var(--text-tertiary);
      padding-bottom: 6px;
    }
    .stuck-block-count {
      margin-left: auto;
      text-align: right;
      padding-bottom: 4px;
    }
    .stuck-block-number {
      font-family: var(--mono);
      font-size: var(--text-xl);
      font-weight: 300;
      color: var(--signal-amber);
      line-height: 1;
    }
    .stuck-block-label {
      font-family: var(--mono);
      font-size: 10px;
      color: var(--text-tertiary);
      margin-top: 2px;
    }

    /* Pipeline stations */
    .stuck-pipeline {
      display: flex;
      gap: var(--space-2);
      padding: 0 var(--space-5) var(--space-4);
      flex-wrap: wrap;
    }
    .stuck-station {
      flex: 1;
      min-width: 64px;
      background: var(--obsidian-light);
      border: 1px solid var(--glass-border);
      border-radius: var(--radius-sm);
      padding: var(--space-3) var(--space-2);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: var(--space-1);
      text-align: center;
    }
    .stuck-station--critical {
      border-color: rgba(239, 68, 68, 0.30);
      background: rgba(239, 68, 68, 0.04);
    }
    .stuck-station--stalled {
      border-color: rgba(251, 191, 36, 0.25);
      background: rgba(251, 191, 36, 0.03);
    }
    .stuck-station-abbr {
      font-family: var(--mono);
      font-size: var(--text-xs);
      color: var(--text-primary);
      letter-spacing: 0.04em;
    }
    .stuck-station-icon--critical { color: var(--signal-red); font-size: 13px; }
    .stuck-station-icon--stalled  { color: var(--signal-amber); font-size: 13px; }
    .stuck-station-icon--clear    { color: var(--signal-green); font-size: 13px; }
    .stuck-station-days {
      font-family: var(--mono);
      font-size: 10px;
    }
    .stuck-station-days--critical { color: var(--signal-red); }
    .stuck-station-days--stalled  { color: var(--signal-amber); }
    .stuck-station-days--clear    { color: var(--text-tertiary); }

    /* Intervention */
    .stuck-intervention {
      margin: 0 var(--space-5) var(--space-4);
      background: var(--glass);
      border: 1px solid var(--glass-border);
      border-left: 2px solid rgba(239, 68, 68, 0.40);
      border-radius: var(--radius-sm);
      padding: var(--space-3) var(--space-4);
    }
    .stuck-intervention-step {
      font-family: var(--mono);
      font-size: 10px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--signal-red);
      margin-bottom: var(--space-1);
    }
    .stuck-intervention-action {
      font-family: var(--sans);
      font-size: var(--text-sm);
      color: var(--text-secondary);
      line-height: 1.5;
    }

    /* Footer */
    .stuck-footer {
      padding: var(--space-3) var(--space-5) var(--space-4);
      border-top: 1px solid var(--glass-border);
      display: flex;
      justify-content: flex-end;
    }
  </style>

  {# Header: permit ID + address + severity badge #}
  <div class="stuck-header">
    <div>
      <div class="stuck-permit-id">{{ stuck.permit }}</div>
      <div class="stuck-address">{{ stuck.address }}</div>
    </div>
    {% set sev = (stuck.severity or stuck.severity_tier or 'HIGH') | upper %}
    <span class="stuck-severity-badge {{ 'stuck-severity-badge--critical' if sev == 'CRITICAL' else 'stuck-severity-badge--high' }}">
      <span class="stuck-dot {{ 'stuck-dot--critical' if sev == 'CRITICAL' else 'stuck-dot--high' }}"></span>
      {{ sev }}
    </span>
  </div>

  {# Hero: days stuck + block count #}
  <div class="stuck-hero">
    <div class="stuck-days-number">{{ stuck.days_stuck }}</div>
    <div class="stuck-days-label">days stuck</div>
    {% if stuck.block_count %}
    <div class="stuck-block-count">
      <div class="stuck-block-number">{{ stuck.block_count }}</div>
      <div class="stuck-block-label">agencies blocked</div>
    </div>
    {% endif %}
  </div>

  {# Pipeline station blocks #}
  {% if stuck.blocks %}
  <div class="stuck-pipeline">
    {% for block in stuck.blocks %}
    {% set is_critical = block.status in ['critically_stalled'] %}
    {% set is_stalled  = block.status in ['stalled', 'comments'] %}
    <div class="stuck-station {{ 'stuck-station--critical' if is_critical else ('stuck-station--stalled' if is_stalled else '') }}">
      <span class="stuck-station-abbr">{{ block.station }}</span>
      <span class="{{ 'stuck-station-icon--critical' if is_critical else ('stuck-station-icon--stalled' if is_stalled else 'stuck-station-icon--clear') }}">
        {{ '✗' if (is_critical or is_stalled) else '✓' }}
      </span>
      <span class="stuck-station-days {{ 'stuck-station-days--critical' if is_critical else ('stuck-station-days--stalled' if is_stalled else 'stuck-station-days--clear') }}">
        {{ block.dwell_days }}d
      </span>
    </div>
    {% endfor %}
  </div>
  {% endif %}

  {# First intervention step #}
  {% if stuck.playbook %}
  {% set first = stuck.playbook[0] %}
  <div class="stuck-intervention">
    <div class="stuck-intervention-step">{{ first.priority }} — Step {{ first.step }}</div>
    <div class="stuck-intervention-action">{{ first.action | truncate(90, True, '…') }}</div>
  </div>
  {% endif %}

  <div class="stuck-footer">
    <a href="/tools/stuck-permit?permit={{ stuck.permit }}"
       class="showcase-card__cta"
       data-track="showcase-click"
       data-showcase="stuck">See full playbook →</a>
  </div>
</div>
{% else %}
<div class="showcase-card" style="padding: var(--space-6);">
  <div style="font-family: var(--mono); font-size: var(--text-sm); color: var(--text-tertiary); font-style: italic;">
    Live permit data unavailable
  </div>
</div>
{% endif %}
